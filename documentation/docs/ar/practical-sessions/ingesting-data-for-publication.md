---
title: إدخال البيانات للنشر
---

# إدخال البيانات للنشر

!!! abstract "نتائج التعلم"

    بنهاية هذه الجلسة العملية، ستكون قادرًا على:
    
    - تشغيل سير عمل `wis2box` عن طريق تحميل البيانات إلى MinIO باستخدام واجهة MinIO على الويب أو SFTP أو سكربت Python.
    - الوصول إلى لوحة تحكم Grafana لمراقبة حالة إدخال البيانات وعرض سجلات مثيل `wis2box` الخاص بك.
    - عرض إشعارات بيانات WIS2 التي ينشرها `wis2box` الخاص بك باستخدام MQTT Explorer.

## المقدمة

في WIS2، يتم مشاركة البيانات في الوقت الفعلي باستخدام إشعارات بيانات WIS2 التي تحتوي على رابط "قياسي" يمكن من خلاله تنزيل البيانات.

لتشغيل سير عمل البيانات في WIS2 Node باستخدام برنامج `wis2box`، يجب تحميل البيانات إلى حاوية **wis2box-incoming** في **MinIO**، مما يؤدي إلى بدء سير عمل `wis2box`. ينتج عن هذه العملية نشر البيانات عبر إشعار بيانات WIS2. بناءً على تعيينات البيانات المكونة في مثيل `wis2box` الخاص بك، قد يتم تحويل البيانات إلى تنسيق BUFR قبل نشرها.

في هذا التمرين، سنستخدم ملفات بيانات نموذجية لتشغيل سير عمل `wis2box` و**نشر إشعارات بيانات WIS2** لمجموعة البيانات التي قمت بتكوينها في الجلسة العملية السابقة.

أثناء التمرين، سنراقب حالة إدخال البيانات باستخدام **لوحة تحكم Grafana** و**MQTT Explorer**. تستخدم لوحة تحكم Grafana بيانات من Prometheus وLoki لعرض حالة `wis2box` الخاص بك، بينما يتيح لك MQTT Explorer رؤية إشعارات بيانات WIS2 التي ينشرها مثيل `wis2box` الخاص بك.

في هذا التمرين، سنركز على الطرق المختلفة لتحميل البيانات إلى مثيل `wis2box` الخاص بك والتحقق من نجاح الإدخال والنشر. سيتم تغطية تحويل البيانات لاحقًا في الجلسة العملية [أدوات تحويل البيانات](./data-conversion-tools.md).

## التحضير

تستخدم هذه القسم مجموعة البيانات لـ "surface-based-observations/synop" و"other" التي تم إنشاؤها مسبقًا في الجلسة العملية [تكوين مجموعات البيانات في wis2box](./configuring-wis2box-datasets.md).

كما يتطلب معرفة بتكوين المحطات في **wis2box-webapp**، كما هو موضح في الجلسة العملية [تكوين بيانات المحطات](./configuring-station-metadata.md).

تأكد من أنه يمكنك تسجيل الدخول إلى جهاز الطالب الافتراضي الخاص بك باستخدام عميل SSH (مثل PuTTY).

تأكد من أن `wis2box` يعمل:

```bash
cd ~/wis2box/
python3 wis2box-ctl.py start
python3 wis2box-ctl.py status
```

تأكد من تشغيل MQTT Explorer ومتصل بمثيلك باستخدام بيانات الاعتماد العامة `everyone/everyone` مع الاشتراك في الموضوع `origin/a/wis2/#`.

تأكد من فتح متصفح ويب مع لوحة تحكم Grafana لمثيلك عن طريق الانتقال إلى `http://YOUR-HOST:3000`.

## إدخال البيانات باستخدام واجهة MinIO

أولاً، سنستخدم واجهة MinIO على الويب، التي تتيح لك تنزيل وتحميل البيانات إلى MinIO باستخدام متصفح ويب.

### الوصول إلى واجهة MinIO

افتح واجهة MinIO على الويب، والتي تكون متاحة عادةً على `http://YOUR-HOST:9001`.

<img alt="Minio UI: minio ui" src="/../assets/img/minio-ui.png" width="400">

يمكن العثور على بيانات الاعتماد WIS2BOX_STORAGE_USERNAME وWIS2BOX_STORAGE_PASSWORD في ملف wis2box.env.

إذا لم تكن متأكدًا من القيم، يرجى الانتقال إلى الدليل الجذر لـ `wis2box` وتشغيل الأمر التالي لعرض بيانات الاعتماد ذات الصلة فقط:

```bash
grep -E '^(WIS2BOX_STORAGE_USERNAME|WIS2BOX_STORAGE_PASSWORD)=' wis2box.env
```

استخدم قيم WIS2BOX_STORAGE_USERNAME وWIS2BOX_STORAGE_PASSWORD كاسم المستخدم وكلمة المرور عند تسجيل الدخول إلى MinIO.

### إدخال البيانات والنشر باستخدام المكون الإضافي Universal

قم بتنزيل بيانات العينة geps [geps_202508180000.grib2](../sample-data/geps_202508180000.grib2) في بيئتك المحلية:

حدد الحاوية wis2box-incoming وانقر على `Create new path`.

<img alt="minio ui: create new path" src="/../assets/img/minio-create-new-path.png" width="800">

يجب أن يتطابق اسم المسار مع معرف البيانات الوصفية لمجموعة بيانات "other" الخاصة بك، والتي قمت بإنشائها مسبقًا في الجلسة العملية [تكوين مجموعات البيانات في wis2box](./configuring-wis2box-datasets.md).

<img alt="minio ui: create new path empty" src="/../assets/img/minio-ui-create-path-empty.png" width="700">

لذلك في هذه الحالة، يرجى إنشاء الدليل:

```bash
urn:wmo:md:my-centre-id:my-other-dataset
```

ادخل إلى الدليل الذي تم إنشاؤه حديثًا، انقر على `Upload`، وابحث عن [geps_202508180000.grib2](../sample-data/geps_202508180000.grib2) الذي قمت بتنزيله إلى جهازك المحلي من قبل وقم بتحميل هذا الملف إلى حاوية wis2box-incoming.

<img alt="minio ui: upload your file" src="/../assets/img/minio-other-dataset-upload.png" width="650">

بمجرد الانتهاء من التحميل، سترى هذا الملف في حاوية wis2box-incoming في MinIO:

<img alt="minio ui: upload your file" src="/../assets/img/minio-geps-file-upload.png" width="650">

بعد التحميل، تحقق باستخدام MQTT Explorer للتأكد من أن البيانات تم نشرها بنجاح.

<img alt="mqtt explorer: message notification geps data" src="/../assets/img/mqtt-explorer-wis2-notification-geps-sample.png" width="800">

بعد ذلك، قم بتنزيل بيانات العينة geps بامتداد ملف مختلف [geps_202508180000.nc](../sample-data/geps_202508180000.nc) في بيئتك المحلية. قم بتحميل هذا الملف إلى نفس الدليل كما فعلت في التمرين السابق.

!!! question "سؤال"

    هل يمكنك التحميل بنجاح إلى حاوية wis2box-incoming؟

??? success "اضغط للكشف عن الإجابة"

    نعم.
    <img alt="Minio ui: geps nc file" src="/../assets/img/minio-upload-geps-with-nc-extension.png" width="800">

!!! question "سؤال"

    هل يمكنك نشر رسائل إشعار البيانات بنجاح من خلال MinIO؟ 
    تحقق من لوحة تحكم Grafana وMQTT Explorer لمعرفة ما إذا تم إدخال البيانات ونشرها بنجاح.

!!! hint

    عند إنشاء مجموعة بيانات مخصصة، أي مكون إضافي استخدمته؟
    هل يحتوي المكون الإضافي على أي متطلبات لتنسيق الملف، وأين يتم تحديدها؟

??? success "اضغط للكشف عن الإجابة"

    لا.
    سترى رسالة تشير إلى وجود خطأ في نوع الملف غير المعروف.

    ```bash
    ERROR - Path validation error: Unknown file type (nc) for metadata_id=urn:wmo:md:nl-knmi-test:customized-geps-dataset-wis2-training. Did not match any of the following:grib2
    ``` 
    
    يوضح هذا أن سير عمل البيانات تم تشغيله، ولكن لم يتم إعادة نشر البيانات. لن يقوم `wis2box` بنشر البيانات إذا لم يتمكن من مطابقة امتداد الملف grib2.

بعد ذلك، قم بتنزيل بيانات العينة geps المعاد تسميتها [geps_renamed_sample_data.grib2](../sample-data/geps_renamed_sample_data.grib2) في بيئتك المحلية. قم بتحميل هذا الملف إلى نفس الدليل كما فعلت في التمرينين السابقين.

!!! question "سؤال"

    هل يمكنك التحميل بنجاح إلى حاوية wis2box-incoming؟

??? success "اضغط للكشف عن الإجابة"

    نعم.
    <img alt="Minio ui: geps nc file" src="/../assets/img/minio-upload-renamed-geps.png" width="800">

!!! question "سؤال"

    هل يمكنك نشر رسائل إشعار البيانات بنجاح من خلال MinIO؟ 
    تحقق من لوحة تحكم Grafana وMQTT Explorer لمعرفة ما إذا تم إدخال البيانات ونشرها بنجاح.

!!! hint

    هل يفرض المكون الإضافي المخصص الذي استخدمته أي متطلبات أو قيود على اسم الملف؟

??? success "اضغط للكشف عن الإجابة"

    لا.
    سترى رسالة تشير إلى وجود خطأ حول عدم تطابق البيانات مع النمط regex.

    ```bash
    ERROR - ERROR - geps_renamed_sample_data.grib2 did not match ^.*?_(\d{8}).*?\..*$
    ``` 
    
    يوضح هذا أن سير عمل البيانات تم تشغيله، ولكن لم يتم إعادة نشر البيانات. لن يقوم `wis2box` بنشر البيانات إذا لم يتمكن من مطابقة نمط الملف ^.*?_(\d{8}).*?\..*$.

يوفر المكون الإضافي Universal آلية عامة لإدخال ونشر الملفات دون تطبيق فك تشفير خاص بالمجال. بدلاً من ذلك، يقوم بإجراء مجموعة من الفحوصات الأساسية قبل نشر إشعار WIS2:

`امتداد الملف` – يجب أن يستخدم الملف الامتداد المسموح به في تكوين مجموعة البيانات.

`نمط اسم الملف` – يجب أن يتطابق اسم الملف مع التعبير العادي المحدد في مجموعة البيانات.

إذا تم استيفاء كلا الشرطين، يتم إدخال الملف ويتم نشر إشعار.

تحميل ملف إلى MinIO ينجح دائمًا طالما أن المستخدم لديه صلاحية الوصول. ومع ذلك، نشر إشعار بيانات WIS2 يتطلب تحققًا أكثر صرامة. الملفات التي لا تستوفي قواعد الامتداد أو اسم الملف سيتم تخزينها في دلو `wis2box-incoming`، ولكن لن يقوم `Universal plugin` بنشر إشعار لها. هذا يفسر سبب قبول MinIO لملفات ذات امتداد غير مدعوم (مثل `geps_202508180000.nc`) أو اسم ملف غير صالح (مثل `geps_renamed_sample_data.grib2`) ولكنها لا تظهر في WIS2.

بعد ذلك، انتقل إلى واجهة MinIO على المتصفح الخاص بك وتصفح إلى دلو `wis2box-incoming`. سترى الملف `geps_202508180000.grib2` الذي قمت بتحميله في التمارين السابقة.

انقر على الملف، وستكون لديك خيار تنزيله:

<img alt="minio-wis2box-incoming-dataset-folder" src="/../assets/img/minio-download.png" width="800">

يرجى تنزيل هذا الملف وإعادة تحميله إلى نفس المسار في MinIO لإعادة تشغيل سير عمل wis2box.

!!! question "سؤال"

    هل يمكنك إعادة نشر رسائل إشعار البيانات بنجاح عبر MinIO؟ 
    تحقق من لوحة معلومات Grafana وMQTT Explorer لمعرفة ما إذا تم استيعاب البيانات ونشرها بنجاح.

??? success "انقر للكشف عن الإجابة"

    سترى رسالة تشير إلى أن wis2box قد نشر بالفعل هذه البيانات:

    ```bash
    ERROR - Data already published for geps_202508180000-grib2; not publishing
    ``` 
    
    هذا يوضح أن سير العمل الخاص بالبيانات تم تشغيله، ولكن البيانات لم تُنشر مرة أخرى. لن يقوم wis2box بنشر نفس البيانات مرتين.

### استيعاب ونشر باستخدام synop2bufr-plugin

قم بتنزيل بيانات synop التجريبية [synop_202502040900.txt](../sample-data/synop_202502040900.txt) لهذا التمرين في بيئتك المحلية:

كما في التمارين السابقة، قم بإنشاء دليل تحت دلو `wis2box-incoming` يتطابق مع معرف البيانات الوصفية لمجموعة بيانات surface-based-observations/synop الخاصة بك.

ادخل إلى الدليل الذي أنشأته حديثًا، انقر على `Upload`، وحدد الملف [synop_202502040900.txt](../sample-data/synop_202502040900.txt) الذي قمت بتنزيله إلى جهازك المحلي ثم قم بتحميله.

!!! question "سؤال"

    هل يمكنك نشر رسائل إشعار البيانات بنجاح عبر MinIO؟ 
    تحقق من لوحة معلومات Grafana وMQTT Explorer لمعرفة ما إذا تم استيعاب البيانات ونشرها بنجاح.

??? success "انقر للكشف عن الإجابة"

    لا. 
    في لوحة معلومات Grafana سترى تحذيرًا يشير إلى فقدان سجل المحطة 64400:

    ```bash
    WARNING - Station 64400 not found in station file
    ``` 
    
    هذا يوضح أن سير العمل الخاص بالبيانات تم تشغيله، ولكن هناك حاجة إلى بيانات وصفية محددة للمحطة.

في هذه الحالة، أنت تستخدم `FM-12 data converted to BUFR` plugin.

الغرض من هذا المكون الإضافي هو التعامل مع بيانات FM-12 المقدمة بتنسيق نصي عادي وتحويلها إلى BUFR ثنائي.
خلال هذه العملية، يحتاج المكون الإضافي إلى تحليل وتعيين معلومات المحطة الواردة في البيانات.

إذا كانت بيانات المحطة الأساسية مفقودة، فلن يتمكن المكون الإضافي من تحليل الملف بشكل صحيح وسيفشل التحويل.

لذلك، يجب التأكد من إضافة بيانات المحطة ذات الصلة إلى wis2box قبل نشر بيانات SYNOP.

لذا الآن، دعنا نضيف محطة اختبار لهذا التمرين.

أضف المحطة بمعرف WIGOS `0-20000-0-64400` إلى مثيل wis2box الخاص بك باستخدام محرر المحطات في wis2box-webapp.

استرجع المحطة من OSCAR:

<img alt="oscar-station" src="/../assets/img/webapp-test-station-oscar-search.png" width="600">

أضف المحطة إلى مجموعات البيانات التي أنشأتها للنشر على "../surface-based-observations/synop" واحفظ التغييرات باستخدام رمز المصادقة الخاص بك:

<img alt="webapp-test-station" src="/../assets/img/webapp-test-station-save.png" width="800">

لاحظ أنه يمكنك إزالة هذه المحطة من مجموعة البيانات الخاصة بك بعد الجلسة العملية.

بعد الانتهاء من تكوين بيانات المحطة، تحقق باستخدام MQTT Explorer للتأكد من أن البيانات نُشرت بنجاح. إذا رأيت الإشعار أدناه، فهذا يعني أنك نشرت بيانات synop التجريبية بنجاح.

<img alt="webapp-test-station" src="/../assets/img/mqtt-explorer-wis2box-notification-synop-sample.png" width="800">

## استيعاب البيانات باستخدام Python (اختياري)

في هذا التمرين، سنستخدم عميل MinIO Python لنسخ البيانات إلى MinIO.

يوفر MinIO عميل Python، يمكن تثبيته كما يلي:

```bash
pip3 install minio
```

على جهاز الطالب الافتراضي الخاص بك، ستكون حزمة 'minio' لـ Python مثبتة بالفعل.

انسخ الدليل `exercise-materials/data-ingest-exercises` إلى الدليل الذي حددته كـ `WIS2BOX_HOST_DATADIR` في ملف `wis2box.env` الخاص بك:

```bash
cp -r ~/exercise-materials/data-ingest-exercises ~/wis2box-data/
```

!!! note
    يتم تحميل `WIS2BOX_HOST_DATADIR` كـ `/data/wis2box/` داخل حاوية wis2box-management بواسطة ملف `docker-compose.yml` المضمن في دليل `wis2box`.
    
    يتيح ذلك مشاركة البيانات بين المضيف والحاوية.

في دليل `exercise-materials/data-ingest-exercises`، ستجد سكربت مثال `copy_file_to_incoming.py` يمكن استخدامه لنسخ الملفات إلى MinIO.

حاول تشغيل السكربت لنسخ ملف البيانات التجريبي `synop_202501030900.txt` إلى دلو `wis2box-incoming` في MinIO كما يلي:

```bash
cd ~/wis2box-data/data-ingest-exercises
python3 copy_file_to_incoming.py synop_202501030900.txt
```

!!! note

    ستواجه خطأ لأن السكربت غير مهيأ للوصول إلى نقطة النهاية MinIO على wis2box الخاص بك حتى الآن.

يحتاج السكربت إلى معرفة نقطة النهاية الصحيحة للوصول إلى MinIO على wis2box الخاص بك. إذا كان wis2box يعمل على مضيفك، فإن نقطة النهاية MinIO متاحة على `http://YOUR-HOST:9000`. كما يحتاج السكربت إلى التحديث بكلمة مرور التخزين الخاصة بك والمسار في دلو MinIO لتخزين البيانات.

!!! question "تحديث السكربت واستيعاب بيانات CSV"
    
    قم بتحرير السكربت `copy_file_to_incoming.py` لمعالجة الأخطاء، باستخدام إحدى الطرق التالية:
    - من سطر الأوامر: استخدم محرر النصوص `nano` أو `vim` لتحرير السكربت.
    - باستخدام WinSCP: ابدأ اتصالًا جديدًا باستخدام بروتوكول الملف `SCP` ونفس بيانات الاعتماد الخاصة بعميل SSH الخاص بك. انتقل إلى الدليل `wis2box-data/data-ingest-exercises` وقم بتحرير `copy_file_to_incoming.py` باستخدام محرر النصوص المدمج.
    
    تأكد من أنك:

    - تحدد نقطة النهاية الصحيحة لـ MinIO لمضيفك.
    - توفر كلمة مرور التخزين الصحيحة لمثيل MinIO الخاص بك.
    - توفر المسار الصحيح في دلو MinIO لتخزين البيانات.

    أعد تشغيل السكربت لاستيعاب ملف البيانات التجريبي `synop_202501030900.txt` في MinIO:

    ```bash
    python3 ~/wis2box-data/ ~/wis2box-data/synop_202501030900.txt
    ```

    تأكد من حل الأخطاء.

بمجرد أن تتمكن من تشغيل السكربت بنجاح، سترى رسالة تشير إلى أن الملف تم نسخه إلى MinIO، ويجب أن ترى إشعارات البيانات التي نشرها مثيل wis2box الخاص بك في MQTT Explorer.

يمكنك أيضًا التحقق من لوحة معلومات Grafana لمعرفة ما إذا تم استيعاب البيانات ونشرها بنجاح.

الآن بعد أن أصبح السكربت يعمل، يمكنك محاولة نسخ ملفات أخرى إلى MinIO باستخدام نفس السكربت.

!!! question "استيعاب البيانات الثنائية بتنسيق BUFR"

    قم بتشغيل الأمر التالي لنسخ ملف البيانات الثنائية `bufr-example.bin` إلى دلو `wis2box-incoming` في MinIO:

    ```bash
    python3 copy_file_to_incoming.py bufr-example.bin
    ```

تحقق من لوحة معلومات Grafana وMQTT Explorer لمعرفة ما إذا تم استيعاب البيانات التجريبية ونشرها بنجاح. إذا رأيت أي أخطاء، حاول حلها.

!!! question "التحقق من استيعاب البيانات"

    كم عدد الرسائل التي تم نشرها إلى وسيط MQTT لهذه العينة من البيانات؟

??? success "انقر للكشف عن الإجابة"

    سترى أخطاء تم الإبلاغ عنها في Grafana حيث أن المحطات في ملف BUFR غير معرفة في قائمة المحطات لمثيل wis2box الخاص بك. 
    
    إذا كانت جميع المحطات المستخدمة في ملف BUFR معرفة في مثيل wis2box الخاص بك، يجب أن ترى 10 رسائل منشورة إلى وسيط MQTT. كل إشعار يتوافق مع بيانات لمحطة واحدة ووقت ملاحظة واحد.

    يقوم المكون الإضافي `wis2box.data.bufr4.ObservationDataBUFR` بتقسيم ملف BUFR إلى رسائل BUFR فردية وينشر رسالة واحدة لكل محطة ووقت ملاحظة.

## استيعاب البيانات عبر SFTP (اختياري)

يمكن الوصول إلى خدمة MinIO في wis2box أيضًا عبر SFTP. يتم ربط خادم SFTP لـ MinIO بالمنفذ 8022 على المضيف (المنفذ 22 مستخدم لـ SSH).

في هذا التمرين، سنوضح كيفية استخدام WinSCP لتحميل البيانات إلى MinIO باستخدام SFTP.

يمكنك إعداد اتصال جديد في WinSCP كما هو موضح في لقطة الشاشة التالية:

<img alt="winscp-sftp-connection" src="/../assets/img/winscp-sftp-login.png" width="400">

بيانات الاعتماد لاتصال SFTP يتم تعريفها بواسطة `WIS2BOX_STORAGE_USERNAME` و `WIS2BOX_STORAGE_PASSWORD` في ملف `wis2box.env` الخاص بك، وهي نفس بيانات الاعتماد التي استخدمتها للاتصال بواجهة MinIO.

عند تسجيل الدخول، ستظهر لك الحاويات (buckets) التي يستخدمها `wis2box` في MinIO:

<img alt="winscp-sftp-bucket" src="/../assets/img/winscp-buckets.png" width="600">

يمكنك الانتقال إلى الحاوية `wis2box-incoming` ثم إلى المجلد الخاص بمجموعة البيانات الخاصة بك. ستظهر الملفات التي قمت بتحميلها في التمارين السابقة:

<img alt="winscp-sftp-incoming-path" src="/../assets/img/winscp-incoming-data-path.png" width="600">

!!! question "تحميل البيانات باستخدام SFTP"

    قم بتنزيل هذا الملف النموذجي إلى جهاز الكمبيوتر الخاص بك:

    [synop_202503030900.txt](./../sample-data/synop_202503030900.txt) (انقر بزر الماوس الأيمن واختر "حفظ باسم" لتنزيل الملف).

    ثم قم بتحميله إلى مسار مجموعة البيانات الواردة في MinIO باستخدام جلسة SFTP الخاصة بك في WinSCP.

    تحقق من لوحة التحكم في Grafana وMQTT Explorer لمعرفة ما إذا تم استيعاب البيانات ونشرها بنجاح.

??? success "انقر للكشف عن الإجابة"

    يجب أن ترى إشعار بيانات WIS2 جديدًا منشورًا للمحطة التجريبية `0-20000-0-64400`، مما يشير إلى أن البيانات تم استيعابها ونشرها بنجاح.

    <img alt="grafana_data_ingest" src="/../assets/img/grafana_data-ingest-test3.png" width="400"> 

    إذا استخدمت المسار الخاطئ، ستظهر رسالة خطأ في السجلات.

## الخاتمة

!!! success "تهانينا!"
    في هذه الجلسة العملية، تعلمت كيفية:

    - تشغيل سير عمل `wis2box` عن طريق تحميل البيانات إلى MinIO باستخدام طرق مختلفة.
    - تصحيح الأخطاء الشائعة في عملية استيعاب البيانات باستخدام لوحة التحكم في Grafana وسجلات مثيل `wis2box` الخاص بك.
    - مراقبة إشعارات بيانات WIS2 المنشورة بواسطة `wis2box` الخاص بك في لوحة التحكم في Grafana وMQTT Explorer.