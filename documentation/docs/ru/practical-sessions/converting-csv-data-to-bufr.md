---
title: Преобразование данных CSV в BUFR
---

# Преобразование данных CSV в BUFR

!!! abstract "Учебные результаты"
    К концу этого практического занятия вы сможете:

    - использовать **MinIO UI** для загрузки входных файлов данных CSV и мониторинга результатов
    - знать формат данных CSV для использования с шаблоном BUFR стандартной автоматической метеостанции
    - использовать редактор наборов данных в **wis2box webapp** для создания набора данных для публикации сообщений DAYCLI
    - знать формат данных CSV для использования с шаблоном DAYCLI BUFR
    - использовать **wis2box webapp** для проверки и преобразования образцов данных для станций AWS в BUFR (необязательно)

## Введение

Файлы данных с разделителями-запятыми (CSV) часто используются для записи наблюдений и других данных в табличном формате.
Большинство регистраторов данных, используемых для записи выходных данных датчиков, могут экспортировать наблюдения в файлах с разделителями, включая CSV.
Аналогично, когда данные загружаются в базу данных, легко экспортировать необходимые данные в файлах с форматированием CSV.
Для облегчения обмена данными, первоначально хранящимися в табличных форматах данных, в wis2box был реализован конвертер CSV в BUFR,
использующий тот же программный продукт, что и для преобразования SYNOP в BUFR.

На этом занятии вы узнаете о использовании конвертера csv2bufr в wis2box для следующих встроенных шаблонов:

- **AWS** (aws-template.json) : Шаблон сопоставления для преобразования данных CSV из упрощенного файла автоматической метеостанции в последовательность BUFR 301150, 307096"
- **DayCLI** (daycli-template.json) : Шаблон сопоставления для преобразования ежедневных климатических данных CSV в последовательность BUFR 307075

## Подготовка

Убедитесь, что wis2box-stack был запущен с помощью `python3 wis2box.py start`

Убедитесь, что у вас открыт веб-браузер с MinIO UI для вашего экземпляра, перейдя по адресу `http://<your-host>:9000`
Если вы не помните свои учетные данные MinIO, вы можете найти их в файле `wis2box.env` в каталоге `wis2box-1.0.0rc1` на вашей студенческой виртуальной машине.

Убедитесь, что у вас открыт и подключен MQTT Explorer к вашему брокеру с использованием учетных данных `everyone/everyone`.

## Упражнение 1: Использование csv2bufr с шаблоном 'AWS'

Шаблон 'AWS' предоставляет предопределенный шаблон сопоставления для преобразования данных CSV с метеостанций AWS в поддержку требований отчетности GBON.

Описание шаблона AWS можно найти [здесь](/csv2bufr-templates/aws-template).

### Просмотрите пример входных данных aws

Загрузите пример для этого упражнения по ссылке ниже:

[aws-example.csv](/sample-data/aws-example.csv)

Откройте загруженный файл в редакторе и изучите содержимое:

!!! question
    Изучая поля даты, времени и идентификации (идентификаторы WIGOS и традиционные идентификаторы), что вы заметили? Как будет представлена сегодняшняя дата?

??? success "Нажмите, чтобы увидеть ответ"
    Каждый столбец содержит отдельную информацию. Например, дата разделена на год, месяц и день, отражая то, как данные хранятся в BUFR. Сегодняшняя дата будет разделена на столбцы "год", "месяц" и "день". Аналогично, время должно быть разделено на "час" и "минуту", а идентификатор станции WIGOS на его соответствующие компоненты.

!!! question
    Глядя на файл данных, как кодируются отсутствующие данные?

??? success "Нажмите, чтобы увидеть ответ"
    Отсутствующие данные в файле представлены пустыми ячейками. В файле CSV это будет закодировано как ``,,``. Обратите внимание, что это пустая ячейка, а не закодированная как строка нулевой длины, например, ``,"",``.

!!! hint "Отсутствующие данные"
    Признается, что данные могут отсутствовать по разным причинам, будь то из-за сбоя датчика или ненаблюдения параметра. В этих случаях отсутствующие данные могут быть закодированы, как указано выше, другие данные в отчете остаются действительными.

!!! question
    Какие идентификаторы станций WIGOS для станций, сообщающих данные в примере файла? Как они определены во входном файле?

??? success "Нажмите, чтобы увидеть ответ"

    Идентификатор станции WIGOS определяется четырьмя отдельными столбцами в файле:

    - **wsi_series**: серия идентификаторов WIGOS
    - **wsi_issuer**: издатель идентификатора WIGOS
    - **wsi_issue_number**: номер выпуска WIGOS
    - **wsi_local**: локальный идентификатор WIGOS

    Идентификаторы станций WIGOS, используемые в примере файла, это `0-20000-0-60351`, `0-20000-0-60355` и `0-20000-0-60360`. 

### Обновите пример файла

Обновите пример файла, который вы загрузили, используя сегодняшнюю дату и время, и измените идентификаторы станций WIGOS на станции, которые вы зарегистрировали в wis2box-webapp.

### Загрузите данные в MinIO и проверьте результат

Перейдите в MinIO UI и войдите, используя учетные данные из файла `wis2box.env`.

Перейдите в **wis2box-incoming** и нажмите кнопку "Создать новый путь":

<img alt="Изображение, показывающее интерфейс MinIO с выделенной кнопкой создания папки" src="../../assets/img/minio-create-new-path.png"/>

Создайте новую папку в корзине MinIO, которая соответствует идентификатору набора данных для набора данных, который вы создали с template='weather/surface-weather-observations/synop':

<img alt="Изображение, показывающее интерфейс MinIO с выделенной кнопкой создания папки" src="../../assets/img/minio-create-new-path-metadata_id.png"/>

Загрузите пример файла, который вы загрузили, в папку, которую вы создали в корзине MinIO:

<img alt="Изображение, показывающее интерфейс MinIO с загруженным aws-example" src="../../assets/img/minio-upload-aws-example.png"/></center>

Проверьте панель управления Grafana по адресу `http://<your-host>:3000`, чтобы увидеть, есть ли какие-либо ПРЕДУПРЕЖДЕНИЯ или ОШИБКИ. Если вы видите какие-либо, попробуйте их исправить и повторите упражнение.

Проверьте MQTT Explorer, чтобы увидеть, получаете ли вы уведомления о данных WIS2.

Если вы успешно загрузили данные, вы должны увидеть 3 уведомления в MQTT Explorer на тему `origin/a/wis2/<centre-id>/data/weather/surface-weather-observations/synop` для 3 станций, о которых вы сообщили данные:

<img width="450" alt="Изображение, показывающее MQTT explorer после загрузки AWS" src="../../assets/img/mqtt-explorer-aws-upload.png"/>

## Упражнение 2 - Использование шаблона 'DayCLI'

В предыдущем упражнении мы использовали набор данных, который вы создали с Data-type='weather/surface-weather-observations/synop', который предварительно настроен на шаблон преобразования CSV в BUFR для шаблона AWS.

В следующем упражнении мы будем использовать шаблон 'DayCLI' для преобразования ежедневных климатических данных в BUFR.

Описание шаблона DAYCLI можно найти [здесь](/csv2bufr-templates/daycli-template).

!!! Note "О шаблоне DAYCLI"
    Обратите внимание, что последовательность DAYCLI BUFR будет обновлена в 2025 году для включения дополнительной информации и пересмотренных флагов КК. Шаблон DAYCLI, включенный в wis2box, будет обновлен, чтобы отразить эти изменения. ВМО сообщит, когда программное обеспечение wis2box будет обновлено для включения нового шаблона DAYCLI, чтобы пользователи могли обновить свои системы соответственно.

### Создание набора данных wis2box для публикации сообщений DAYCLI

Перейдите в редактор наборов данных в wis2box-webapp и создайте новый набор данных. Используйте тот же centre-id, что и в предыдущих практических занятиях, и выберите **Data Type='climate/surface-based-observations/daily'**:

<img alt="Создайте новый набор данных в wis2box-webapp для DAYCLI" src="../../assets/img/wis2box-webapp-create-dataset-daycli.png"/>

Нажмите "CONTINUE TO FORM" и добавьте описание для вашего набора данных, установите ограничивающий прямоугольник и предоставьте контактную информацию для набора данных. Как только вы закончите заполнять все разделы, нажмите 'VALIDATE FORM' и проверьте форму.

Просмотрите плагины данных для наборов данных. Нажмите "UPDATE" рядом с плагином с именем "CSV data converted to BUFR", и вы увидите, что шаблон установлен на **DayCLI**:

<img alt="Обновите плагин данных для набора данных, чтобы использовать шаблон DAYCLI" src="../../assets/img/wis2box-webapp-update-data-plugin-daycli.png"/>

Закройте конфигурацию плагина и отправьте форму, используя токен аутентификации, который вы создали на предыдущем практическом занятии.

Теперь у вас должен быть второй набор данных в wis2box-webapp, настроенный на использование шаблона DAYCLI для преобразования данных CSV в BUFR.

### Просмотрите пример входных данных daycli

Загрузите пример для этого упражнения по ссылке ниже:

[daycli-example.csv](/sample-data/daycli-example.csv)

Откройте загруженный файл в редакторе и изучите содержимое:

!!! question
    Какие дополнительные переменные включены в шаблон daycli?

??? success "Нажмите, чтобы увидеть ответ"
    Шаблон daycli включает важные метаданные о расположении приборов и классификациях качества измерений температуры и влажности, флаги контроля качества и информацию о том, как была рассчитана среднесуточная температура.

### Обновите пример файла

Пример файла содержит одну строку данных за каждый день в месяце и сообщает данные для одной станции. Обновите пример файла, который вы загрузили, используя сегодняшнюю дату и время, и измените идентификаторы станций WIGOS на станцию, которую вы зарегистрировали в wis2box-webapp.

### Загрузите данные в MinIO и проверьте результат

Как и раньше, вам нужно будет загрузить данные в корзину 'wis2box-incoming' в MinIO для обработки конвертером csv2bufr. На этот раз вам нужно будет создать новую папку в корзине MinIO, которая соответствует идентификатору набора данных для набора данных, который вы создали с template='climate/surface-based-observations/daily', который будет отличаться от идентификатора набора данных, который вы использовали в предыдущем упражнении:

<img alt="Изображение, показывающее интерфейс MinIO с загруженным DAYCLI-example" src="../../assets/img/minio-upload-daycli-example.png"/></center>

После загрузки данных проверьте, нет ли ПРЕДУПРЕЖДЕНИЙ или ОШИБОК на панели управления Grafana, и проверьте MQTT Explorer, чтобы увидеть, получаете ли вы уведомления о данных WIS2.

Если вы успешно загрузили данные, вы должны увидеть 30 уведомлений в MQTT Explorer на тему `origin/a/wis2/<centre-id>/data/climate/surface-based-observations/daily` за 30 дней в месяце, о которых вы сообщили данные:

<img width="450" alt="Изображение, показывающее MQTT explorer после загрузки DAYCLI" src="../../assets/img/mqtt-daycli-template-success.png"/>

## Упражнение 3 - использование формы CSV в wis2box-webapp (необязательно)

Веб-приложение wis2box предоставляет интерфейс для загрузки данных CSV и их преобразования в BUFR перед публикацией в WIS2, используя шаблон AWS.

Использование этой формы предназначено для отладки и проверки, рекомендуемый метод отправки для публикации данных с автоматизированных метеостанций - настроить процесс, который автоматически загружает данные в корзину MinIO.

### Использование формы CSV в веб-приложении wis2box

Перейдите к форме CSV на веб-приложении wis2box
(``http://<your-host-name>/