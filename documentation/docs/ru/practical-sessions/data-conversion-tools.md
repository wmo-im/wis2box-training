---
title: Инструменты конвертации данных
---

# Инструменты конвертации данных

!!! abstract "Результаты обучения"
    По завершении этого практического занятия вы сможете:

    - Получить доступ к инструментам командной строки ecCodes внутри контейнера wis2box-api
    - Использовать инструмент synop2bufr для конвертации отчетов FM-12 SYNOP в BUFR из командной строки
    - Запускать конвертацию synop2bufr через wis2box-webapp
    - Использовать инструмент csv2bufr для конвертации данных CSV в BUFR из командной строки

## Введение

Данные, публикуемые в WIS2, должны соответствовать требованиям и стандартам, определенным различными экспертными сообществами в области наук о Земле. Чтобы снизить барьер для публикации данных наземных поверхностных наблюдений, wis2box предоставляет инструменты для конвертации данных в формат BUFR. Эти инструменты доступны через контейнер wis2box-api и могут использоваться из командной строки для тестирования процесса конвертации данных.

Основные конвертации, поддерживаемые wis2box в настоящее время - это конвертация отчетов FM-12 SYNOP в BUFR и данных CSV в BUFR. Формат FM-12 поддерживается, поскольку он все еще широко используется и обменивается в сообществе WMO, а поддержка CSV данных позволяет отображать данные, производимые автоматическими метеостанциями, в формат BUFR.

### О FM-12 SYNOP

Отчеты о погоде с наземных станций исторически передавались ежечасно или в основные (00, 06, 12 и 18 UTC) и промежуточные (03, 09, 15, 21 UTC) синоптические сроки. До перехода на BUFR эти отчеты кодировались в текстовой форме FM-12 SYNOP. Хотя переход на BUFR планировалось завершить к 2012 году, большое количество отчетов все еще передается в устаревшем формате FM-12 SYNOP. Дополнительную информацию о формате FM-12 SYNOP можно найти в Наставлении по кодам WMO, том I.1 (WMO-No. 306, том I.1).

### Об ecCodes

Библиотека ecCodes представляет собой набор программных библиотек и утилит, предназначенных для декодирования и кодирования метеорологических данных в форматах GRIB и BUFR. Она разрабатывается Европейским центром среднесрочных прогнозов погоды (ECMWF), подробнее см. [документацию ecCodes](https://confluence.ecmwf.int/display/ECC/ecCodes+documentation).

Программное обеспечение wis2box включает библиотеку ecCodes в базовый образ контейнера wis2box-api. Это позволяет пользователям получать доступ к инструментам командной строки и библиотекам внутри контейнера. Библиотека ecCodes используется в wis2box-stack для декодирования и кодирования сообщений BUFR.

### О csv2bufr и synop2bufr

В дополнение к ecCodes, wis2box использует следующие модули Python, которые работают с ecCodes для конвертации данных в формат BUFR:

- **synop2bufr**: для поддержки устаревшего формата FM-12 SYNOP, традиционно используемого наблюдателями вручную. Модуль synop2bufr использует дополнительные метаданные станций для кодирования дополнительных параметров в файл BUFR. См. [репозиторий synop2bufr на GitHub](https://github.com/World-Meteorological-Organization/synop2bufr)
- **csv2bufr**: для обеспечения конвертации CSV-выгрузок, создаваемых автоматическими метеостанциями, в формат BUFR. Модуль csv2bufr используется для конвертации данных CSV в формат BUFR с использованием шаблона отображения, который определяет, как данные CSV должны отображаться в формат BUFR. См. [репозиторий csv2bufr на GitHub](https://github.com/World-Meteorological-Organization/csv2bufr)

Эти модули могут использоваться автономно или как часть стека wis2box.

## Подготовка

!!! warning "Предварительные требования"

    - Убедитесь, что ваш wis2box настроен и запущен
    - Убедитесь, что вы настроили набор данных и сконфигурировали как минимум одну станцию в вашем wis2box
    - Подключитесь к MQTT брокеру вашего экземпляра wis2box используя MQTT Explorer
    - Откройте веб-приложение wis2box (`http://YOUR-HOST/wis2box-webapp`) и убедитесь, что вы вошли в систему
    - Откройте панель Grafana для вашего экземпляра, перейдя по адресу `http://YOUR-HOST:3000`

Чтобы использовать инструменты командной строки BUFR, вам нужно будет войти в контейнер wis2box-api. Если не указано иное, все команды должны выполняться в этом контейнере. Вам также понадобится открытый MQTT Explorer, подключенный к вашему брокеру.

Сначала подключитесь к вашей учебной VM через SSH-клиент и скопируйте материалы упражнений в контейнер wis2box-api:

```bash
docker cp ~/exercise-materials/data-conversion-exercises wis2box-api:/root
```

Затем войдите в контейнер wis2box-api и перейдите в каталог, где находятся материалы упражнений:

```bash
cd ~/wis2box
python3 wis2box-ctl.py login wis2box-api
cd /root/data-conversion-exercises
```

Подтвердите, что инструменты доступны, начиная с ecCodes:

```bash
bufr_dump -V
```

Вы должны получить следующий ответ:

```
ecCodes Version 2.36.0
```

Далее проверьте версию synop2bufr:

```bash
synop2bufr --version
```

Вы должны получить следующий ответ:

```
synop2bufr, version 0.7.0
```

Далее проверьте csv2bufr:

```bash
csv2bufr --version
```

Вы должны получить следующий ответ:

```
csv2bufr, version 0.8.5
```

## Инструменты командной строки ecCodes

Библиотека ecCodes, включенная в контейнер wis2box-api, предоставляет ряд инструментов командной строки для работы с файлами BUFR. 
Следующие упражнения демонстрируют, как использовать `bufr_ls` и `bufr_dump` для проверки содержимого файла BUFR.

### bufr_ls

В первом упражнении вы будете использовать команду `bufr_ls` для проверки заголовков файла BUFR и определения типа содержимого файла.

Используйте следующую команду для запуска `bufr_ls` на файле `bufr-cli-ex1.bufr4`:

```bash
bufr_ls bufr-cli-ex1.bufr4
```

Вы должны увидеть следующий вывод:

```bash
bufr-cli-ex1.bufr4
centre                     masterTablesVersionNumber  localTablesVersionNumber   typicalDate                typicalTime                numberOfSubsets
cnmc                       29                         0                          20231002                   000000                     1
1 of 1 messages in bufr-cli-ex1.bufr4

1 of 1 total messages in 1 file
```

Различные опции могут быть переданы в `bufr_ls` для изменения как формата, так и выводимых полей заголовка.

!!! question
     
    Какой командой можно вывести предыдущий результат в формате JSON?

    Вы можете запустить команду `bufr_ls` с флагом `-h`, чтобы увидеть доступные опции.

??? success "Нажмите, чтобы увидеть ответ"
    Вы можете изменить формат вывода на JSON, используя флаг `-j`, т.е.
    ```bash
    bufr_ls -j bufr-cli-ex1.bufr4
    ```

    При выполнении это должно дать следующий вывод:
    ```
    { "messages" : [
      {
        "centre": "cnmc",
        "masterTablesVersionNumber": 29,
        "localTablesVersionNumber": 0,
        "typicalDate": 20231002,
        "typicalTime": "000000",
        "numberOfSubsets": 1
      }
    ]}
    ```

Выведенные значения представляют собой значения некоторых ключей заголовка в файле BUFR.

Сама по себе эта информация не очень информативна, предоставляя только ограниченную информацию о содержимом файла.

При изучении файла BUFR мы часто хотим определить тип данных, содержащихся в файле, и типичную дату/время данных в файле. Эту информацию можно вывести с помощью флага `-p` для выбора заголовков для вывода. Несколько заголовков можно включить, используя список, разделенный запятыми.

Вы можете использовать следующую команду для вывода категории данных, подкатегории, типичной даты и времени:
    
```bash
bufr_ls -p dataCategory,internationalDataSubCategory,typicalDate,typicalTime -j bufr-cli-ex1.bufr4
```

!!! question

    Выполните предыдущую команду и интерпретируйте вывод, используя [Common Code Table C-13](https://github.com/wmo-im/CCT/blob/master/C13.csv) для определения категории и подкатегории данных.

    Какой тип данных (категория и подкатегория данных) содержится в файле? Какая типичная дата и время для данных?

??? success "Нажмите, чтобы увидеть ответ"
    
    ```
    { "messages" : [
      {
        "dataCategory": 2,
        "internationalDataSubCategory": 4,
        "typicalDate": 20231002,
        "typicalTime": "000000"
      }
    ]}
    ```

    Из этого мы видим, что:

    - Категория данных - 2, что указывает на данные **"Вертикальные зондирования (кроме спутниковых)"**.
    - Международная подкатегория - 4, что указывает на **"Сообщения о температуре/влажности/ветре на высотах со стационарных наземных станций (TEMP)"**.
    - Типичная дата и время - 2023-10-02 и 00:00:00z соответственно.

### bufr_dump

Команда `bufr_dump` может использоваться для просмотра и изучения содержимого файла BUFR, включая сами данные.

Попробуйте запустить команду `bufr_dump` на втором примере файла `bufr-cli-ex2.bufr4`:

```{.copy}
bufr_dump bufr-cli-ex2.bufr4
```

Это приводит к выводу JSON, который может быть трудно анализировать, попробуйте использовать флаг `-p` для вывода данных в текстовом формате (формат ключ=значение):

```{.copy}
bufr_dump -p bufr-cli-ex2.bufr4
```

Вы увидите большое количество ключей в выводе, многие из которых отсутствуют. Это типично для реальных данных, так как не все ключи eccodes заполнены отчетными данными.

Вы можете использовать команду `grep` для фильтрации вывода и показа только тех ключей, которые не отсутствуют. Например, чтобы показать все ключи, которые не отсутствуют, вы можете использовать следующую команду:

```{.copy}
bufr_dump -p bufr-cli-ex2.bufr4 | grep -v MISSING
```

!!! question

    Какое давление, приведенное к среднему уровню моря, указано в файле BUFR `bufr-cli-ex2.bufr4`?

??? success "Нажмите, чтобы увидеть ответ"

    Используя следующую команду:

    ```bash
    bufr_dump -p bufr-cli-ex2.bufr4 | grep -i 'pressureReducedToMeanSeaLevel'
    ```

    Вы должны увидеть следующий вывод:

    ```
    pressureReducedToMeanSeaLevel=105590
    ```
    Это указывает, что давление, приведенное к среднему уровню моря, составляет 105590 Па (1055.90 гПа).

!!! question

    Какой идентификатор WIGOS станции, которая передала данные в файле BUFR `bufr-cli-ex2.bufr4`?

??? success "Нажмите, чтобы увидеть ответ"

    Используя следующую команду:

    ```bash
    bufr_dump -p bufr-cli-ex2.bufr4 | grep -i 'wigos'
    ```

    Вы должны увидеть следующий вывод:

    ```
    wigosIdentifierSeries=0
    wigosIssuerOfIdentifier=20000
    wigosIssueNumber=0
    