---
title: Работа с данными BUFR
---

# Работа с данными BUFR

!!! abstract "Учебные результаты"
    В этом практическом занятии вы познакомитесь с некоторыми инструментами BUFR, включенными в контейнер **wis2box-api**, которые используются для преобразования данных в формат BUFR и для чтения содержимого, закодированного в BUFR.
    
    Вы узнаете:

    - как проверить заголовки в файле BUFR с помощью команды `bufr_ls`
    - как извлечь и проверить данные в файле bufr с помощью `bufr_dump`
    - основную структуру шаблонов bufr, используемых в csv2bufr, и как использовать инструмент командной строки
    - и как внести основные изменения в шаблоны bufr и как обновить wis2box для использования измененной
      версии

## Введение

Плагины, которые производят уведомления с данными BUFR, используют процессы в wis2box-api для работы с данными BUFR, например, для преобразования данных из CSV в BUFR или из BUFR в geojson.

Контейнер wis2box-api включает в себя ряд инструментов для работы с данными BUFR.

К ним относятся инструменты, разработанные ECMWF и включенные в программное обеспечение ecCodes, более подробную информацию о них можно найти на [сайте ecCodes](https://confluence.ecmwf.int/display/ECC/BUFR+tools).

На этом занятии вы познакомитесь с `bufr_ls` и `bufr_dump` из программного пакета ecCodes и продвинутой настройкой инструмента csv2bufr.

## Подготовка

Для использования командной строки BUFR вам необходимо будет войти в контейнер wis2box-api
и, если не указано иное, все команды должны выполняться в этом контейнере. Вам также потребуется открыть и подключить MQTT Explorer к вашему брокеру.

Сначала подключитесь к вашей студенческой VM через ваш ssh-клиент, а затем войдите в контейнер wis2box-api:

```{.copy}
cd ~/wis2box-1.0.0rc1
python3 wis2box-ctl.py login wis2box-api
```

Подтвердите, что инструменты доступны, начиная с ecCodes:

``` {.copy}
bufr_dump -V
```
Вы должны получить следующий ответ:

```
ecCodes Version 2.28.0
```

Затем проверьте csv2bufr:

```{.copy}
csv2bufr --version
```

Вы должны получить следующий ответ:

```
csv2bufr, версия 0.7.4
```

Наконец, создайте рабочий каталог для работы:

```{.copy}
cd /data/wis2box
mkdir -p working/bufr-cli
cd working/bufr-cli
```

Теперь вы готовы начать использовать инструменты BUFR.


## Использование инструментов командной строки BUFR

### Упражнение 1 - bufr_ls
В этом первом упражнении вы будете использовать команду `bufr_ls` для проверки заголовков файла BUFR и для определения содержимого файла. В файл BUFR включены следующие заголовки:

| заголовок                            | ключ ecCodes                  | описание                                                                                                                                           |
|-----------------------------------|------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------|
| центр происхождения/генерации     | centre                       | Центр происхождения / генерации данных                                                                                                      |
| подцентр происхождения/генерации | bufrHeaderSubCentre          | Подцентр происхождения / генерации данных                                                                                                  | 
| Номер последовательности обновления            | updateSequenceNumber         | Является ли это первой версией данных (0) или обновлением (>0)                                                                                   |               
| Категория данных                     | dataCategory                 | Тип данных, содержащихся в сообщении BUFR, например, данные о поверхности. См. [Таблицу A BUFR](https://github.com/wmo-im/BUFR4/blob/master/BUFR_TableA_en.csv)  |
| Международная подкатегория данных   | internationalDataSubCategory | Подтип данных, содержащихся в сообщении BUFR, например, данные о поверхности. См. [Общую таблицу кодов C-13](https://github.com/wmo-im/CCT/blob/master/C13.csv) |
| Год                              | typicalYear (typicalDate)    | Наиболее типичное время для содержимого сообщения BUFR                                                                                                       |
| Месяц                             | typicalMonth (typicalDate)   | Наиболее типичное время для содержимого сообщения BUFR                                                                                                       |
| День                               | typicalDay (typicalDate)     | Наиболее типичное время для содержимого сообщения BUFR                                                                                                       |
| Час                              | typicalHour (typicalTime)    | Наиболее типичное время для содержимого сообщения BUFR                                                                                                       |
| Минута                            | typicalMinute (typicalTime)  | Наиболее типичное время для содержимого сообщения BUFR                                                                                                       |
| Дескрипторы BUFR                  | unexpandedDescriptors        | Список одного или нескольких дескрипторов BUFR, определяющих данные, содержащиеся в файле                                                                        |

Загрузите пример файла напрямую в контейнер управления wis2box с помощью следующей команды:

``` {.copy}
curl https://training.wis2box.wis.wmo.int/sample-data/bufr-cli-ex1.bufr4 --output bufr-cli-ex1.bufr4
```

Теперь используйте следующую команду для запуска `bufr_ls` на этом файле:

```bash
bufr_ls bufr-cli-ex1.bufr4
```

Вы должны увидеть следующий вывод:

```bash
bufr-cli-ex1.bufr4
centre                     masterTablesVersionNumber  localTablesVersionNumber   typicalDate                typicalTime                numberOfSubsets
cnmc                       29                         0                          20231002                   000000                     1
1 из 1 сообщений в bufr-cli-ex1.bufr4

1 из 1 общих сообщений в 1 файлах
```

Сама по себе эта информация не очень информативна, поскольку она содержит ограниченную информацию о содержимом файла.

Стандартный вывод не предоставляет информации о типе наблюдения или данных и имеет формат, который не очень легко читать. Однако можно передать различные параметры `bufr_ls` для изменения как формата, так и полей заголовка, которые выводятся.

Используйте `bufr_ls` без аргументов, чтобы просмотреть параметры:

```{.copy}
bufr_ls
```

Вы должны увидеть следующий вывод:

```
NAME    bufr_ls

DESCRIPTION
        Список содержимого файлов BUFR, вывод значений некоторых ключей заголовков.
        Могут быть напечатаны только скалярные ключи.
        Не выдает ошибку, если ключ не найден.

USAGE
        bufr_ls [options] bufr_file bufr_file ...

OPTIONS
        -p key[:{s|d|i}],key[:{s|d|i}],...
                Объявление ключей для печати.
                Для каждого ключа можно запросить строку (key:s), двойное значение (key:d) или целое число (key:i)
                Тип по умолчанию - строка.
        -F format
                Формат стиля C для значений с плавающей точкой.
        -P key[:{s|d|i}],key[:{s|d|i}],...
                Как -p, добавляя объявленные ключи к списку по умолчанию.
        -w key[:{s|d|i}]{=|!=}value,key[:{s|d|i}]{=|!=}value,...
                Клаузула where.
                Сообщения обрабатываются только в том случае, если они соответствуют всем ограничениям ключа/значения.
                Допустимое ограничение - это тип key=value или key!=value.
                Для каждого ключа можно указать строку (key:s), двойное значение (key:d) или целое число (key:i)
                Тип по умолчанию - строка.
                В значении также можно использовать символ косой черты '/' для указания условия ИЛИ (т. е. логического разделения)
                Примечание: разрешена только одна клаузула -w.
        -j      Вывод JSON
        -s key[:{s|d|i}]=value,key[:{s|d|i}]=value,...
                Установка ключей/значений.
                Для каждого ключа можно определить строку (key:s), двойное значение (key:d) или целое число (key:i)
                По умолчанию устанавливается собственный тип.
        -n namespace
                Выводятся все ключи, принадлежащие данному пространству имен.
        -m      Печатаются ключи Mars.
        -V      Версия.
        -W width
                Минимальная ширина каждого столбца в выводе. По умолчанию 10.
        -g      Копировать заголовок GTS.
        -7      Не выдает ошибку, если сообщение имеет неправильную длину

SEE ALSO
        Полная документация и примеры на:
        <https://confluence.ecmwf.int/display/ECC/bufr_ls>
```

Теперь запустите ту же команду на примере файла, но выведите информацию в формате JSON.

!!! question
    Какой флаг вы передаете команде `bufr_ls`, чтобы просмотреть вывод в формате JSON?

??? success "Нажмите, чтобы увидеть ответ"
    Вы можете изменить формат вывода на json, используя флаг `-j`, т.е.
    `bufr_ls -j <input-file>`. Это может быть более читаемым, чем формат вывода по умолчанию. Смотрите пример вывода ниже:

    ```
    { "messages" : [
      {
        "centre": "cnmc",
        "masterTablesVersionNumber": 29,
        "localTablesVersionNumber": 0,
        "typicalDate": 20231002,
        "typicalTime": "000000",
        "numberOfSubsets": 1
      }
    ]}
    ```

При изучении файла BUFR мы часто хотим определить тип данных, содержащихся в файле, и типичные дату / время
данных в файле. Эту информацию можно вывести, используя флаг `-p` для выбора заголовков для вывода. Несколько
заголовков можно включить, используя список, разделенный запятыми.

Используя команду `bufr_ls`, проверьте тестовый файл и определите тип данных, содержащихся в файле, и типичные дату и время для этих данных.

??? hint
    Ключи ecCodes приведены в таблице выше. Мы можем использовать следующее для вывода dataCategory и
    internationalDataSubCategory данных BUFR:

    ```
    bufr_ls -p dataCategory,internationalDataSubCategory bufr-cli-ex1.bufr4
    ```

    Дополнительные ключи можно добавить по мере необходимости.

!!! question
    Какой тип данных (категория данных и подкатегория) содержится в файле? Каковы типичные дата и время
    для данных?

??? success "Нажмите, чтобы увидеть ответ"
    Команда, которую вам нужно было запустить, должна была быть похожа на:
    
    ```
    bufr_ls -p dataCategory,internationalDataSubCategory,typicalDate,typicalTime -j bufr-cli-ex1.bufr4
    ```

    Возможно, у вас есть дополнительные ключи или вы перечислили год, месяц, день и т. д. индивидуально. Вывод должен
    быть похож на приведенный ниже, в зависимости от того, выбрали ли вы вывод в формате JSON или по умолчанию.

    ```
    { "messages" : [
      {
        "dataCategory": 2,
        "internationalDataSubCategory": 4,
        "typicalDate": 20231002,
        "typicalTime": "000000"
      }
    ]}
    ```

    Из этого мы видим, что:

    - Категория данных - 2, из [Таблицы A BUFR](https://github.com/wmo-im/BUFR4/blob/master/BUFR_TableA_en.csv)
      мы видим, что этот файл содержит данные "Вертикальные зондирования (кроме спутниковых)".
    - Международная подкатегория - 4, указывающая
      "Отчеты о температуре/влажности/ветре верхних уровней от стационарных наземных станций (TEMP)" данные. Эту информацию можно найти
      в [Общей таблице кодов C-13](https://github.com/wmo-im/CCT/blob/master/C13.csv) (строка 33). Обратите внимание на комбинацию
      категории и подкатегории.
    - Типичные дата и время - 2023/10/02 и 00:00:00z соответственно.

    

### Упражнение 2 - bufr_dump

Команда `bufr_dump` может быть использована для вывода и изучения содержимого файла BUFR, включая сами данные.

В этом упражнении мы будем использовать файл BUFR, который такой же, как тот, который вы создали во время начального практического занятия csv2bufr с использованием wis2box-webapp.

Загрузите образец файла в контейнер управления wis2box напрямую с помощью следующей команды:

``` {.copy}
curl https://training.wis2box.wis.wmo.int/sample-data/bufr-cli-ex2.bufr4 --output bufr-cli-ex2.bufr4
```

Теперь запустите команду `bufr_dump` на файле, используя флаг `-p` для вывода данных в виде обычного текста (формат key=value):

```{.copy}
bufr_dump -p bufr-cli-ex2.bufr4
```

Вы должны увидеть около 240 ключей, многие из которых отсутствуют. Это типично для реальных данных, поскольку не все ключи eccodes заполнены сообщаемыми данными.

!!! hint
    Отсутствующие значения можно отфильтровать с помощью таких инструментов, как `grep`:
    ```{.copy}
    bufr_dump -p bufr-cli-ex2.bufr4 | grep -v MISSING
    ```

Примерный файл BUFR для этого упражнения взят из практического занятия csv2bufr. Пожалуйста, загрузите исходный файл CSV в ваше текущее местоположение следующ