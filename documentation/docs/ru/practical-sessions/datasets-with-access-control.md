---
title: Настройка рекомендуемого набора данных с управлением доступом
---

# Настройка рекомендуемого набора данных с управлением доступом

!!! abstract "Результаты обучения"
    К концу этой практической сессии вы сможете:

    - создать новый набор данных с политикой данных 'recommended'
    - добавить токен доступа к набору данных
    - проверить, что доступ к набору данных невозможен без токена доступа
    - добавить токен доступа в HTTP-заголовки для доступа к набору данных

## Введение

Наборы данных, которые не считаются 'core' в WMO, могут быть дополнительно настроены с политикой управления доступом. wis2box предоставляет механизм добавления токена доступа к набору данных, который предотвращает загрузку данных пользователями, если они не предоставляют токен доступа в HTTP-заголовках.

## Подготовка

Убедитесь, что у вас есть доступ по SSH к вашей виртуальной машине (VM) студента и что ваш экземпляр wis2box запущен и работает.

Убедитесь, что вы подключены к MQTT брокеру вашего экземпляра wis2box с использованием MQTT Explorer. Вы можете использовать публичные учетные данные `everyone/everyone` для подключения к брокеру.

Убедитесь, что у вас открыт веб-браузер с wis2box-webapp для вашего экземпляра, перейдя по адресу `http://YOUR-HOST/wis2box-webapp`.

## Создание нового набора данных с политикой данных 'recommended'

Перейдите на страницу 'dataset editor' в wis2box-webapp и создайте новый набор данных. Выберите Data Type = 'weather/surface-weather-observations/synop'.

<img alt="create-dataset-recommended" src="/../assets/img/create-dataset-template.png" width="800">

Для "Centre ID" используйте то же значение, что и в предыдущих практических заданиях.

Нажмите 'CONTINUE TO FORM', чтобы продолжить.

Замените автоматически сгенерированный 'Local ID' на описательное имя для набора данных, например, 'recommended-data-with-access-control', и обновите поля 'Title' и 'Description':

<img alt="create-dataset-recommended" src="/../assets/img/create-dataset-recommended.png" width="800">

Измените политику данных WMO на 'recommended', и вы увидите, что форма добавила новое поле для ввода URL с информацией о лицензии для набора данных:

<img alt="create-dataset-license" src="/../assets/img/create-dataset-license.png" width="800">

У вас есть возможность указать URL лицензии, описывающей условия использования набора данных. Например, вы можете использовать 
`https://creativecommons.org/licenses/by/4.0/` 
для указания лицензии Creative Commons Attribution 4.0 International (CC BY 4.0).

Или вы можете использовать `WIS2BOX_URL/data/license.txt` для указания пользовательского файла лицензии, размещенного на вашем собственном веб-сервере, где `WIS2BOX_URL` — это URL, определенный в файле wis2box.env:

<img alt="create-dataset-license-url" src="/../assets/img/create-dataset-license-custom.png" width="800">

Продолжите заполнять обязательные поля для пространственных свойств и контактной информации, а затем нажмите 'Validate form', чтобы проверить наличие ошибок.

Наконец, отправьте набор данных, используя ранее созданный токен аутентификации, и проверьте, что новый набор данных создан в wis2box-webapp.

Проверьте MQTT Explorer, чтобы убедиться, что вы получили WIS2 Notification Message, объявляющее новую запись Discovery Metadata в теме `origin/a/wis2/<your-centre-id>/metadata`.

## Просмотр нового набора данных в wis2box-api

Просмотрите список наборов данных в wis2box-api, открыв URL `WIS2BOX_URL/oapi/collections/discovery-metadata/items` в вашем веб-браузере, заменив `WIS2BOX_URL` на URL вашего экземпляра wis2box.

Откройте ссылку на только что созданный набор данных и прокрутите вниз до раздела 'links' в JSON-ответе:

<img alt="wis2box-api-recommended-dataset-links" src="/../assets/img/wis2box-api-recommended-dataset-links.png" width="600">

Вы должны увидеть ссылку "License for this dataset", указывающую на URL, который вы указали в редакторе набора данных.

Если вы использовали `http://YOUR-HOST/data/license.txt` в качестве URL лицензии, ссылка в данный момент не будет работать, так как мы еще не добавили файл лицензии в экземпляр wis2box.

Если время позволяет, вы можете добавить пользовательский файл лицензии в ваш экземпляр wis2box в конце этой практической сессии. Сначала мы продолжим с добавлением токена доступа к набору данных.

## Добавление токена доступа к набору данных

Войдите в контейнер wis2box-management,

```bash
cd ~/wis2box
python3 wis2box-ctl.py login
```

Из командной строки внутри контейнера вы можете защитить набор данных, используя команду `wis2box auth add-token`, с флагом `--metadata-id` для указания идентификатора метаданных набора данных и токеном доступа в качестве аргумента.

Например, чтобы добавить токен доступа `S3cr3tT0k3n` к набору данных с идентификатором метаданных `urn:wmo:md:not-my-centre:core.surface-based-observations.synop`:

```bash
wis2box auth add-token --metadata-id urn:wmo:md:not-my-centre:reco.surface-based-observations.synop S3cr3tT0k3n
```

Выйдите из контейнера wis2box-management:

```bash
exit
```

## Публикация данных в набор данных

Скопируйте файл `exercise-materials/access-control-exercises/aws-example.csv` в директорию, определенную переменной `WIS2BOX_HOST_DATADIR` в вашем `wis2box.env`:

```bash
cp ~/exercise-materials/access-control-exercises/aws-example.csv ~/wis2box-data
```

Затем используйте WinSCP или редактор командной строки, чтобы отредактировать файл `aws-example.csv` и обновить идентификаторы станций WIGOS в входных данных, чтобы они соответствовали станциям в вашем экземпляре wis2box.

Далее перейдите в редактор станций в wis2box-webapp. Для каждой станции, которую вы использовали в `aws-example.csv`, обновите поле 'topic', чтобы оно соответствовало 'topic' набора данных, созданного в предыдущем упражнении.

Теперь эта станция будет связана с двумя темами: одной для набора данных 'core' и одной для набора данных 'recommended':

<img alt="edit-stations-add-topics" src="/../assets/img/edit-stations-add-topics.png" width="600">

Вам потребуется использовать ваш токен для `collections/stations`, чтобы сохранить обновленные данные станции.

Затем войдите в контейнер wis2box-management:

```bash
cd ~/wis2box
python3 wis2box-ctl.py login
```

Из командной строки wis2box мы можем загрузить пример файла данных `aws-example.csv` в определенный набор данных следующим образом:

```bash
wis2box data ingest -p /data/wis2box/aws-example.csv --metadata-id urn:wmo:md:not-my-centre:reco.surface-based-observations.synop
```

Убедитесь, что вы указали правильный идентификатор метаданных для вашего набора данных, и **проверьте, что вы получаете WIS2 data-notifications в MQTT Explorer**, в теме `origin/a/wis2/<your-centre-id>/data/recommended/surface-based-observations/synop`.

Проверьте каноническую ссылку в WIS2 Notification Message и скопируйте/вставьте ссылку в браузер, чтобы попытаться загрузить данные.

Вы должны увидеть сообщение *401 Unauthorized*.

## Добавление токена доступа в HTTP-заголовки для доступа к набору данных

Чтобы продемонстрировать, что для доступа к набору данных требуется токен доступа, мы воспроизведем ошибку, которую вы видели в браузере, используя функцию командной строки `wget`.

Из командной строки вашей виртуальной машины студента используйте команду `wget` с канонической ссылкой, которую вы скопировали из WIS2 Notification Message.

```bash
wget <canonical-link>
```

Вы должны увидеть, что HTTP-запрос возвращает *401 Unauthorized*, и данные не загружаются.

Теперь добавьте токен доступа в HTTP-заголовки для доступа к набору данных.

```bash
wget --header="Authorization: Bearer S3cr3tT0k3n" <canonical-link>
```

Теперь данные должны быть успешно загружены.

## Добавление пользовательского файла лицензии в ваш экземпляр wis2box (опционально)

Создайте текстовый файл на вашем локальном компьютере, используя ваш любимый текстовый редактор, и добавьте в файл информацию о лицензии, например:

*Это пользовательский файл лицензии для рекомендуемого набора данных с управлением доступом. Вы можете свободно использовать эти данные, но, пожалуйста, указывайте источник данных.*

Чтобы загрузить локально созданный файл license.txt, используйте MinIO Console, доступный на порту 9001 вашего экземпляра wis2box, перейдя в веб-браузере по адресу `http://YOUR-HOST:9001`.

Учетные данные для доступа к MinIO Console определены переменными окружения `WIS2BOX_STORAGE_USERNAME` и `WIS2BOX_STORAGE_PASSWORD` в файле wis2box.env. Вы можете найти их следующим образом:

```bash
cat wis2box.env | grep WIS2BOX_STORAGE_USERNAME
cat wis2box.env | grep WIS2BOX_STORAGE_PASSWORD
```

После входа в MinIO Console вы можете загрузить файл лицензии в базовый путь **wis2box-public** bucket, используя кнопку "Upload":

<img alt="minio-upload-license" src="/../assets/img/minio-upload-license.png" width="800">

После загрузки файла лицензии проверьте, доступен ли файл, посетив `WIS2BOX_URL/data/license.txt` в вашем веб-браузере, заменив `WIS2BOX_URL` на URL вашего экземпляра wis2box.

!!! note

    Веб-прокси в wis2box проксирует все файлы, хранящиеся в "wis2box-public" bucket, по пути `WIS2BOX_URL/data/`.

Ссылка "License for this dataset", включенная в метаданные вашего рекомендуемого набора данных, теперь должна работать.

## Заключение

!!! success "Поздравляем!"
    В этой практической сессии вы научились:

    - создавать новый набор данных с политикой данных 'recommended'
    - добавлять токен доступа к набору данных
    - проверять, что доступ к набору данных невозможен без токена доступа
    - добавлять токен доступа в HTTP-заголовки для доступа к набору данных
    - добавлять пользовательский файл лицензии в ваш экземпляр wis2box