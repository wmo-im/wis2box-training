---
title: Настройка рекомендованного набора данных с управлением доступом
---

# Настройка рекомендованного набора данных с управлением доступом

!!! abstract "Результаты обучения"
    По окончании этой практической сессии вы сможете:

    - создать новый набор данных с политикой данных 'recommended'
    - добавить токен доступа к набору данных
    - проверить, что набор данных недоступен без токена доступа
    - добавить токен доступа в HTTP-заголовки для доступа к набору данных
    - добавить пользовательский файл лицензии, размещённый на вашем экземпляре wis2box

## Введение

Данные в WIS2 распространяются в соответствии с Единой политикой данных ВМО (WMO Unified Data Policy), которая описывает две категории данных:

- **core**: данные, предоставляемые на бесплатной и неограниченной основе, без оплаты и без условий использования
- **recommended**: данные, которые могут предоставляться с условиями использования и/или подлежать лицензированию

Данные, распространяемые как recommended:

- могут быть предоставлены с условиями использования и повторного использования
- могут иметь управление доступом
- не кэшируются службами WIS2 Global Cache Services
- должны содержать ссылку на лицензию, указывающую условия использования данных, включённую в метаданные обнаружения

Редактор наборов данных в wis2box-webapp потребует указать URL лицензии при выборе политики данных 'recommended'. Дополнительно вы можете добавить токен доступа к набору данных, чтобы ограничить доступ к данным.

В этой практической сессии вы создадите новый набор данных с политикой данных 'recommended' и научитесь добавлять управление доступом.

Также в этой сессии вы узнаете, как добавить пользовательский файл лицензии в ваш экземпляр wis2box.

## Подготовка

Убедитесь, что у вас есть доступ по SSH к вашей виртуальной машине (VM) для студентов и что ваш экземпляр wis2box запущен и работает.

Убедитесь, что вы подключены к брокеру MQTT вашего экземпляра wis2box, используя MQTT Explorer. Вы можете использовать публичные учётные данные `everyone/everyone` для подключения к брокеру.

Убедитесь, что у вас открыт веб-браузер с доступом к wis2box-webapp вашего экземпляра, перейдя по адресу `http://YOUR-HOST/wis2box-webapp`.

## Создание нового набора данных с политикой данных 'recommended'

Перейдите на страницу 'dataset editor' в wis2box-webapp и создайте новый набор данных. Выберите Data Type = 'weather/surface-weather-observations/synop'.

<img alt="create-dataset-recommended" src="/../assets/img/create-dataset-template.png" width="800">

Для "Centre ID" используйте то же значение, что и в предыдущих практических заданиях.

Нажмите 'CONTINUE TO FORM', чтобы продолжить.

Замените автоматически сгенерированный 'Local ID' на описательное имя для набора данных, например, 'recommended-data-with-access-control', и обновите поля 'Title' и 'Description':

<img alt="create-dataset-recommended" src="/../assets/img/create-dataset-recommended.png" width="800">

Измените политику данных ВМО на 'recommended', и вы увидите, что форма добавила новое поле для ввода URL, предоставляющего информацию о лицензии для набора данных:

<img alt="create-dataset-license" src="/../assets/img/create-dataset-license.png" width="800">

У вас есть возможность указать URL лицензии, описывающей условия использования набора данных. Например, используйте 
`https://creativecommons.org/licenses/by/4.0/`, чтобы указать лицензию Creative Commons Attribution 4.0 International (CC BY 4.0).

Или `WIS2BOX_URL/data/license.txt`, чтобы указать пользовательский файл лицензии, размещённый на вашем собственном веб-сервере, где `WIS2BOX_URL` — это URL, определённый в файле `wis2box.env`:

<img alt="create-dataset-license-url" src="/../assets/img/create-dataset-license-custom.png" width="800">

Продолжите заполнять обязательные поля для пространственных свойств и контактной информации. Нажмите 'Validate form', чтобы проверить наличие ошибок.

Наконец, отправьте набор данных, используя ранее созданный токен аутентификации, и проверьте, что новый набор данных создан в wis2box-webapp.

Проверьте MQTT Explorer, чтобы убедиться, что вы получили WIS2 Notification Message, объявляющее новую запись метаданных обнаружения в теме `origin/a/wis2/<your-centre-id>/metadata`.

## Просмотр нового набора данных в wis2box-api

Просмотрите список наборов данных в wis2box-api, открыв URL `WIS2BOX_URL/oapi/collections/discovery-metadata/items` в вашем веб-браузере, заменив `WIS2BOX_URL` на URL вашего экземпляра wis2box.

Откройте ссылку на только что созданный набор данных и прокрутите вниз до раздела 'links' в JSON-ответе:

<img alt="wis2box-api-recommended-dataset-links" src="/../assets/img/wis2box-api-recommended-dataset-links.png" width="600">

Вы должны увидеть ссылку "License for this dataset", указывающую на URL, предоставленный в редакторе набора данных.

Если вы использовали `http://YOUR-HOST/data/license.txt` в качестве URL лицензии, ссылка пока не будет работать, так как мы ещё не добавили файл лицензии в экземпляр wis2box.

Если время позволяет, вы можете добавить пользовательский файл лицензии в ваш экземпляр wis2box в конце этой практической сессии. Сначала мы продолжим с добавлением токена доступа к набору данных.

## Добавление токена доступа к набору данных

Войдите в контейнер wis2box-management,

```bash
cd ~/wis2box
python3 wis2box-ctl.py login
```

Из командной строки внутри контейнера вы можете защитить набор данных, используя команду `wis2box auth add-token`, с флагом `--metadata-id` для указания идентификатора метаданных набора данных и токеном доступа в качестве аргумента.

Например, чтобы добавить токен доступа `S3cr3tT0k3n` к набору данных с идентификатором метаданных `urn:wmo:md:not-my-centre:core.surface-based-observations.synop`:

```bash
wis2box auth add-token --metadata-id urn:wmo:md:not-my-centre:reco.surface-based-observations.synop S3cr3tT0k3n
```

Выйдите из контейнера wis2box-management:

```bash
exit
```

## Публикация данных в набор данных

Скопируйте файл `exercise-materials/access-control-exercises/aws-example.csv` в директорию, определённую `WIS2BOX_HOST_DATADIR` в вашем `wis2box.env`:

```bash
cp ~/exercise-materials/access-control-exercises/aws-example.csv ~/wis2box-data
```

Затем используйте WinSCP или редактор командной строки, чтобы отредактировать файл `aws-example.csv` и обновить идентификаторы станций WIGOS в исходных данных так, чтобы они соответствовали станциям, имеющимся в вашем экземпляре wis2box.

Далее перейдите в редактор станций (station-editor) в wis2box-webapp. Для каждой станции, использованной в `aws-example.csv`, обновите поле 'topic', чтобы оно соответствовало 'topic' набора данных, созданного в предыдущем упражнении.

Эта станция теперь будет ассоциирована с двумя темами: одной для набора данных 'core' и одной для набора данных 'recommended':

<img alt="edit-stations-add-topics" src="/../assets/img/edit-stations-add-topics.png" width="600">

Вам потребуется использовать ваш токен для `collections/stations`, чтобы сохранить обновлённые данные станции.

Далее войдите в контейнер wis2box-management:

```bash
cd ~/wis2box
python3 wis2box-ctl.py login
```

Из командной строки wis2box мы можем загрузить пример файла данных `aws-example.csv` в конкретный набор данных следующим образом:

```bash
wis2box data ingest -p /data/wis2box/aws-example.csv --metadata-id urn:wmo:md:not-my-centre:reco.surface-based-observations.synop
```

Убедитесь, что вы указали правильный идентификатор метаданных для вашего набора данных, и **проверьте, что вы получаете уведомления WIS2 о данных в MQTT Explorer** по теме `origin/a/wis2/<your-centre-id>/data/recommended/surface-based-observations/synop`.

Проверьте каноническую ссылку в WIS2 Notification Message, скопируйте и вставьте ссылку в браузер, чтобы попытаться загрузить данные.

Вы должны увидеть сообщение *401 Authorization Required*.

## Добавление токена доступа в HTTP-заголовки для доступа к набору данных

Чтобы продемонстрировать, что для доступа к набору данных требуется токен доступа, мы воспроизведём ошибку, которую вы видели в браузере, используя функцию командной строки `wget`.

Из командной строки вашей виртуальной машины выполните команду `wget` с канонической ссылкой, которую вы скопировали из WIS2 Notification Message.

```bash
wget <canonical-link>
```

Вы должны увидеть, что HTTP-запрос возвращает *401 Unauthorized*, и данные не загружаются.

Теперь добавьте токен доступа в HTTP-заголовки для доступа к набору данных.

```bash
wget --header="Authorization: Bearer S3cr3tT0k3n" <canonical-link>
```

Теперь данные должны успешно загрузиться.

## Добавление пользовательского файла лицензии в ваш экземпляр wis2box

Этот шаг требуется только в том случае, если вы хотите предоставить пользовательскую лицензию, размещённую на вашем экземпляре wis2box, вместо использования внешнего URL лицензии.

Создайте текстовый файл на вашем локальном компьютере, используя ваш любимый текстовый редактор, и добавьте в файл информацию о лицензии, например:

*Это пользовательский файл лицензии для рекомендованного набора данных с управлением доступом. Вы можете свободно использовать эти данные, но, пожалуйста, указывайте источник данных.*

Чтобы загрузить локально созданный файл с именем `license.txt`, используйте MinIO Console, доступный на порту 9001 вашего экземпляра wis2box, открыв веб-браузер и перейдя по адресу `http://YOUR-HOST:9001`.

Учётные данные для доступа к MinIO Console определены переменными окружения `WIS2BOX_STORAGE_USERNAME` и `WIS2BOX_STORAGE_PASSWORD` в файле `wis2box.env`.

Вы можете найти их в файле `wis2box.env`, выполнив следующие команды:

```bash
cat wis2box.env | grep WIS2BOX_STORAGE_USERNAME
cat wis2box.env | grep WIS2BOX_STORAGE_PASSWORD
```

После входа в MinIO Console загрузите файл лицензии в базовый путь **wis2box-public** bucket, используя кнопку "Upload":

<img alt="minio-upload-license" src="/../assets/img/minio-upload-license.png" width="800">

После загрузки файла лицензии проверьте, доступен ли файл, перейдя по адресу `WIS2BOX_URL/data/license.txt` в вашем веб-браузере, заменив `WIS2BOX_URL` на URL вашего экземпляра wis2box.

!!! note

    Веб-прокси в wis2box проксирует все файлы, хранящиеся в "wis2box-public" bucket, по пути `WIS2BOX_URL/data/`

Ссылка "License for this dataset", включённая в метаданные вашего рекомендованного набора данных, теперь должна работать как ожидается.

## Заключение

!!! success "Поздравляем!"
    В этой практической сессии вы научились:

    - создавать новый набор данных с политикой данных 'recommended'
    - добавлять токен доступа к набору данных
    - проверять, что набор данных недоступен без токена доступа
    - добавлять токен доступа в HTTP-заголовки для доступа к набору данных
    - добавлять пользовательский файл лицензии в ваш экземпляр wis2box