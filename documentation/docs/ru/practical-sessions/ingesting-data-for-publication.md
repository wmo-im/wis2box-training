---
title: Загрузка данных для публикации
---

# Загрузка данных для публикации

!!! abstract "Результаты обучения"

    К концу этой практической сессии вы сможете:
    
    - Запускать рабочий процесс wis2box, загружая данные в MinIO через веб-интерфейс MinIO, SFTP или Python-скрипт.
    - Получать доступ к панели мониторинга Grafana для отслеживания статуса загрузки данных и просмотра логов вашего экземпляра wis2box.
    - Просматривать уведомления WIS2 о данных, опубликованных вашим wis2box, с помощью MQTT Explorer.

## Введение

В WIS2 данные передаются в режиме реального времени с использованием уведомлений WIS2 о данных, которые содержат "каноническую" ссылку для загрузки данных.

Чтобы запустить рабочий процесс данных в WIS2 Node с использованием программного обеспечения wis2box, данные должны быть загружены в **бакет wis2box-incoming** в **MinIO**, что инициирует рабочий процесс wis2box. Этот процесс приводит к публикации данных через уведомление WIS2 о данных. В зависимости от настроек отображения данных в вашем экземпляре wis2box данные могут быть преобразованы в формат BUFR перед публикацией.

В этом упражнении мы будем использовать примерные файлы данных для запуска рабочего процесса wis2box и **публикации уведомлений WIS2 о данных** для набора данных, который вы настроили в предыдущей практической сессии.

Во время упражнения мы будем отслеживать статус загрузки данных с помощью **панели мониторинга Grafana** и **MQTT Explorer**. Панель Grafana использует данные из Prometheus и Loki для отображения статуса вашего wis2box, а MQTT Explorer позволяет видеть уведомления WIS2 о данных, опубликованные вашим экземпляром wis2box.

В этом упражнении мы сосредоточимся на различных методах загрузки данных в ваш экземпляр wis2box и проверке успешной загрузки и публикации. Преобразование данных будет рассмотрено позже в практической сессии [Инструменты преобразования данных](./data-conversion-tools.md).

## Подготовка

В этом разделе используется набор данных для "surface-based-observations/synop" и "other", созданный ранее в практической сессии [Настройка наборов данных в wis2box](./configuring-wis2box-datasets.md). 

Также требуется знание настройки станций в **wis2box-webapp**, как описано в практической сессии [Настройка метаданных станции](./configuring-station-metadata.md).

Убедитесь, что вы можете войти в свою виртуальную машину студента с помощью SSH-клиента (например, PuTTY).

Убедитесь, что wis2box запущен:

```bash
cd ~/wis2box/
python3 wis2box-ctl.py start
python3 wis2box-ctl.py status
```

Убедитесь, что MQTT Explorer запущен и подключен к вашему экземпляру с использованием публичных учетных данных `everyone/everyone` с подпиской на топик `origin/a/wis2/#`.

Убедитесь, что у вас открыт веб-браузер с панелью мониторинга Grafana для вашего экземпляра, перейдя по адресу `http://YOUR-HOST:3000`.

## Загрузка данных с использованием интерфейса MinIO

Сначала мы будем использовать веб-интерфейс MinIO, который позволяет загружать и скачивать данные в MinIO через веб-браузер.

### Доступ к интерфейсу MinIO

Откройте веб-интерфейс MinIO, который обычно доступен по адресу `http://YOUR-HOST:9001`.

<img alt="Minio UI: minio ui" src="/../assets/img/minio-ui.png" width="400">

Учетные данные WIS2BOX_STORAGE_USERNAME и WIS2BOX_STORAGE_PASSWORD можно найти в файле wis2box.env.

Если вы не уверены в значениях, перейдите в корневую директорию вашего wis2box и выполните следующую команду, чтобы отобразить только соответствующие учетные данные:

```bash
grep -E '^(WIS2BOX_STORAGE_USERNAME|WIS2BOX_STORAGE_PASSWORD)=' wis2box.env
```
Используйте значения WIS2BOX_STORAGE_USERNAME и WIS2BOX_STORAGE_PASSWORD в качестве имени пользователя и пароля при входе в MinIO.

### Загрузка и публикация с использованием универсального плагина

Скачайте примерные данные geps [geps_202508180000.grib2](../sample-data/geps_202508180000.grib2) в вашу локальную среду:

Выберите бакет wis2box-incoming и нажмите `Create new path`. 

<img alt="minio ui: create new path" src="/../assets/img/minio-create-new-path.png" width="800">

Имя пути должно соответствовать идентификатору метаданных вашего набора данных "other", который вы создали ранее в практической сессии [Настройка наборов данных в wis2box](./configuring-wis2box-datasets.md). 

<img alt="minio ui: create new path empty" src="/../assets/img/minio-ui-create-path-empty.png" width="700">

Таким образом, в данном случае создайте директорию:

```bash
urn:wmo:md:my-centre-id:my-other-dataset
```

Перейдите в только что созданную директорию, нажмите `Upload`, найдите файл [geps_202508180000.grib2](../sample-data/geps_202508180000.grib2), который вы скачали на свой локальный компьютер, и загрузите этот файл в бакет wis2box-incoming.

<img alt="minio ui: upload your file" src="/../assets/img/minio-other-dataset-upload.png" width="650">

После завершения загрузки вы увидите этот файл в бакете wis2box-incoming MinIO:

<img alt="minio ui: upload your file" src="/../assets/img/minio-geps-file-upload.png" width="650">

После загрузки проверьте с помощью MQTT Explorer, чтобы убедиться, что данные были успешно опубликованы.

<img alt="mqtt explorer: message notification geps data" src="/../assets/img/mqtt-explorer-wis2-notification-geps-sample.png" width="800">

Далее скачайте примерные данные geps в другом формате файла [geps_202508180000.nc](../sample-data/geps_202508180000.nc) в вашу локальную среду. Загрузите этот файл в ту же директорию, что и в предыдущем упражнении.

!!! question "Вопрос"

    Удалось ли вам успешно загрузить данные в бакет wis2box-incoming?

??? success "Нажмите, чтобы увидеть ответ"

    Да.
    <img alt="Minio ui: geps nc file" src="/../assets/img/minio-upload-geps-with-nc-extension.png" width="800">

!!! question "Вопрос"

    Удалось ли вам успешно опубликовать уведомления о данных через MinIO? 
    Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно загружены и опубликованы.

!!! hint

    Какой плагин вы использовали при создании пользовательского набора данных?
    Есть ли у плагина требования к формату файлов, и где они указаны?

??? success "Нажмите, чтобы увидеть ответ"

    Нет.
    Вы увидите сообщение об ошибке, указывающее на неизвестный тип файла.

    ```bash
    ERROR - Path validation error: Unknown file type (nc) for metadata_id=urn:wmo:md:nl-knmi-test:customized-geps-dataset-wis2-training. Did not match any of the following:grib2
    ``` 
    
    Это демонстрирует, что рабочий процесс данных был запущен, но данные не были опубликованы повторно. wis2box не публикует данные, если не может сопоставить расширение файла с grib2.

Затем скачайте переименованные примерные данные geps [geps_renamed_sample_data.grib2](../sample-data/geps_renamed_sample_data.grib2) в вашу локальную среду. Загрузите этот файл в ту же директорию, что и в двух предыдущих упражнениях.

!!! question "Вопрос"

    Удалось ли вам успешно загрузить данные в бакет wis2box-incoming?

??? success "Нажмите, чтобы увидеть ответ"

    Да.
    <img alt="Minio ui: geps nc file" src="/../assets/img/minio-upload-renamed-geps.png" width="800">

!!! question "Вопрос"

    Удалось ли вам успешно опубликовать уведомления о данных через MinIO? 
    Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно загружены и опубликованы.

!!! hint

    Накладывает ли используемый вами пользовательский плагин какие-либо требования или ограничения на имя файла?

??? success "Нажмите, чтобы увидеть ответ"

    Нет.
    Вы увидите сообщение об ошибке, указывающее, что данные не соответствуют регулярному выражению.

    ```bash
    ERROR - ERROR - geps_renamed_sample_data.grib2 did not match ^.*?_(\d{8}).*?\..*$
    ``` 
    
    Это демонстрирует, что рабочий процесс данных был запущен, но данные не были опубликованы повторно. wis2box не публикует данные, если имя файла не соответствует шаблону ^.*?_(\d{8}).*?\..*$.

Универсальный плагин предоставляет общий механизм для загрузки и публикации файлов без применения декодирования, специфичного для домена. Вместо этого он выполняет набор базовых проверок перед публикацией уведомления WIS2:

`Расширение файла` – файл должен использовать расширение, разрешенное настройками набора данных.

`Шаблон имени файла` – имя файла должно соответствовать регулярному выражению, определенному в наборе данных.

Если оба условия выполнены, файл загружается, и уведомление публикуется.

Загрузка файла в MinIO всегда проходит успешно, если у пользователя есть доступ. Однако публикация уведомления о данных WIS2 требует более строгой проверки. Файлы, которые не соответствуют правилам расширения или имени файла, будут сохранены в корзине `incoming`, но плагин `Universal plugin` не опубликует уведомление для них. Это объясняет, почему файлы с неподдерживаемым расширением (например, `geps_202508180000.nc`) или с недопустимым именем файла (например, `geps_renamed_sample_data.grib2`) принимаются MinIO, но не отображаются в WIS2.

Далее перейдите в веб-интерфейс MinIO в вашем браузере и откройте корзину `wis2box-incoming`. Вы увидите файл `geps_202508180000.grib2`, который вы загрузили в предыдущих упражнениях.

Нажмите на файл, и у вас появится возможность его скачать:

<img alt="minio-wis2box-incoming-dataset-folder" src="/../assets/img/minio-download.png" width="800">

Пожалуйста, скачайте этот файл и загрузите его обратно в тот же путь в MinIO, чтобы повторно запустить рабочий процесс wis2box.

!!! question "Вопрос"

    Можете ли вы успешно повторно опубликовать уведомления о данных через MinIO? 
    Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно обработаны и опубликованы.

??? success "Нажмите, чтобы увидеть ответ"

    Вы увидите сообщение, указывающее, что wis2box уже опубликовал эти данные:

    ```bash
    ERROR - Data already published for geps_202508180000-grib2; not publishing
    ``` 
    
    Это демонстрирует, что рабочий процесс данных был запущен, но данные не были повторно опубликованы. Wis2box не публикует одни и те же данные дважды.

### Обработка и публикация с использованием synop2bufr-plugin

Скачайте пример данных synop [synop_202502040900.txt](../sample-data/synop_202502040900.txt) для этого упражнения в вашу локальную среду:

Как и в предыдущих упражнениях, создайте каталог в корзине `wis2box-incoming`, который соответствует идентификатору метаданных вашего набора данных surface-based-observations/synop.

Перейдите в только что созданный каталог, нажмите `Upload` и выберите файл [synop_202502040900.txt](../sample-data/synop_202502040900.txt), который вы скачали на свой локальный компьютер, а затем загрузите его.

!!! question "Вопрос"

    Можете ли вы успешно опубликовать уведомления о данных через MinIO? 
    Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно обработаны и опубликованы.

??? success "Нажмите, чтобы увидеть ответ"

    Нет. 
    В панели мониторинга Grafana вы увидите предупреждение, указывающее на отсутствие записи станции 64400:

    ```bash
    WARNING - Station 64400 not found in station file
    ``` 
    
    Это демонстрирует, что рабочий процесс данных был запущен, но требуется метаданные конкретной станции.

В данном случае вы используете плагин `FM-12 data converted to BUFR`.

Цель этого плагина — обработка данных FM-12, предоставленных в текстовом формате, и их преобразование в бинарный формат BUFR. 
В процессе обработки плагин должен анализировать и сопоставлять информацию о станции, содержащуюся в данных.

Если отсутствуют необходимые метаданные станции, плагин не сможет корректно обработать файл, и преобразование завершится с ошибкой.

Поэтому перед публикацией данных SYNOP необходимо убедиться, что соответствующие метаданные станции добавлены в wis2box.

Теперь добавим тестовую станцию для этого упражнения.

Добавьте станцию с идентификатором WIGOS `0-20000-0-64400` в ваш экземпляр wis2box, используя редактор станций в приложении wis2box-webapp.

Получите данные станции из OSCAR:

<img alt="oscar-station" src="/../assets/img/webapp-test-station-oscar-search.png" width="600">

Добавьте станцию в наборы данных, которые вы создали для публикации на "../surface-based-observations/synop", и сохраните изменения, используя ваш токен аутентификации:

<img alt="webapp-test-station" src="/../assets/img/webapp-test-station-save.png" width="800">

Обратите внимание, что вы можете удалить эту станцию из вашего набора данных после практического занятия.

После завершения настройки метаданных станции проверьте с помощью MQTT Explorer, чтобы убедиться, что данные были успешно опубликованы. Если вы видите уведомление ниже, значит, вы успешно опубликовали пример данных synop.

<img alt="webapp-test-station" src="/../assets/img/mqtt-explorer-wis2box-notification-synop-sample.png" width="800">

## Обработка данных с использованием Python (опционально)

В этом упражнении мы будем использовать клиент MinIO для Python, чтобы копировать данные в MinIO.

MinIO предоставляет клиент для Python, который можно установить следующим образом:

```bash
pip3 install minio
```

На вашей виртуальной машине для студентов пакет 'minio' для Python уже будет установлен.

Скопируйте каталог `exercise-materials/data-ingest-exercises` в каталог, который вы определили как `WIS2BOX_HOST_DATADIR` в вашем файле `wis2box.env`:

```bash
cp -r ~/exercise-materials/data-ingest-exercises ~/wis2box-data/
```

!!! note
    Каталог `WIS2BOX_HOST_DATADIR` монтируется как `/data/wis2box/` внутри контейнера wis2box-management с помощью файла `docker-compose.yml`, включенного в каталог `wis2box`.
    
    Это позволяет обмениваться данными между хостом и контейнером.

В каталоге `exercise-materials/data-ingest-exercises` вы найдете пример скрипта `copy_file_to_incoming.py`, который можно использовать для копирования файлов в MinIO.

Попробуйте запустить скрипт, чтобы скопировать пример файла данных `synop_202501030900.txt` в корзину `wis2box-incoming` в MinIO следующим образом:

```bash
cd ~/wis2box-data/data-ingest-exercises
python3 copy_file_to_incoming.py synop_202501030900.txt
```

!!! note

    Вы получите ошибку, так как скрипт не настроен для доступа к конечной точке MinIO на вашем wis2box.

Скрипт должен знать правильную конечную точку для доступа к MinIO на вашем wis2box. Если wis2box работает на вашем хосте, конечная точка MinIO доступна по адресу `http://YOUR-HOST:9000`. Также необходимо обновить скрипт, указав ваш пароль для хранилища и путь в корзине MinIO для сохранения данных.

!!! question "Обновите скрипт и обработайте данные CSV"
    
    Отредактируйте скрипт `copy_file_to_incoming.py`, чтобы устранить ошибки, используя один из следующих методов:
    - Через командную строку: используйте текстовый редактор `nano` или `vim` для редактирования скрипта.
    - С помощью WinSCP: установите новое соединение, используя протокол File Protocol `SCP` и те же учетные данные, что и для вашего SSH-клиента. Перейдите в каталог `wis2box-data/data-ingest-exercises` и отредактируйте `copy_file_to_incoming.py` с помощью встроенного текстового редактора.
    
    Убедитесь, что вы:

    - Указали правильную конечную точку MinIO для вашего хоста.
    - Предоставили правильный пароль для вашего экземпляра MinIO.
    - Указали правильный путь в корзине MinIO для сохранения данных.

    Повторно запустите скрипт, чтобы обработать пример файла данных `synop_202501030900.txt` в MinIO:

    ```bash
    python3 ~/wis2box-data/ ~/wis2box-data/synop_202501030900.txt
    ```

    Убедитесь, что ошибки устранены.

После успешного выполнения скрипта вы увидите сообщение о том, что файл был скопирован в MinIO, и должны увидеть уведомления о данных, опубликованные вашим экземпляром wis2box в MQTT Explorer.

Вы также можете проверить панель мониторинга Grafana, чтобы убедиться, что данные были успешно обработаны и опубликованы.

Теперь, когда скрипт работает, вы можете попробовать скопировать другие файлы в MinIO, используя тот же скрипт.

!!! question "Обработка бинарных данных в формате BUFR"

    Выполните следующую команду, чтобы скопировать бинарный файл данных `bufr-example.bin` в корзину `wis2box-incoming` в MinIO:

    ```bash
    python3 copy_file_to_incoming.py bufr-example.bin
    ```

Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что тестовые данные были успешно обработаны и опубликованы. Если вы видите ошибки, попробуйте их устранить.

!!! question "Проверка обработки данных"

    Сколько сообщений было опубликовано в брокер MQTT для этого примера данных?

??? success "Нажмите, чтобы увидеть ответ"

    Вы увидите ошибки, указанные в Grafana, так как станции в файле BUFR не определены в списке станций вашего экземпляра wis2box. 
    
    Если все станции, используемые в файле BUFR, определены в вашем экземпляре wis2box, вы должны увидеть 10 сообщений, опубликованных в брокер MQTT. Каждое уведомление соответствует данным для одной станции за один временной штамп наблюдения.

    Плагин `wis2box.data.bufr4.ObservationDataBUFR` разделяет файл BUFR на отдельные сообщения BUFR и публикует одно сообщение для каждой станции и временного штампа наблюдения.

## Обработка данных через SFTP (опционально)

Сервис MinIO в wis2box также может быть доступен через SFTP. Сервер SFTP для MinIO привязан к порту 8022 на хосте (порт 22 используется для SSH).

В этом упражнении мы продемонстрируем, как использовать WinSCP для загрузки данных в MinIO через SFTP.

Вы можете настроить новое соединение в WinSCP, как показано на этом скриншоте:

<img alt="winscp-sftp-connection" src="/../assets/img/winscp-sftp-login.png" width="400">

Учетные данные для подключения к SFTP определяются переменными `WIS2BOX_STORAGE_USERNAME` и `WIS2BOX_STORAGE_PASSWORD` в вашем файле `wis2box.env` и совпадают с учетными данными, которые вы использовали для подключения к интерфейсу MinIO.

После входа в систему вы увидите бакеты, используемые wis2box в MinIO:

<img alt="winscp-sftp-bucket" src="/../assets/img/winscp-buckets.png" width="600">

Вы можете перейти в бакет `wis2box-incoming`, а затем в папку для вашего набора данных. Вы увидите файлы, которые вы загрузили в предыдущих упражнениях:

<img alt="winscp-sftp-incoming-path" src="/../assets/img/winscp-incoming-data-path.png" width="600">

!!! question "Загрузка данных с использованием SFTP"

    Скачайте этот пример файла на ваш локальный компьютер:

    [synop_202503030900.txt](./../sample-data/synop_202503030900.txt) (щелкните правой кнопкой мыши и выберите "сохранить как", чтобы загрузить файл).

    Затем загрузите его в путь для входящих данных в MinIO, используя вашу SFTP-сессию в WinSCP.

    Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно обработаны и опубликованы.

??? success "Нажмите, чтобы увидеть ответ"

    Вы должны увидеть новое уведомление WIS2 о данных, опубликованное для тестовой станции `0-20000-0-64400`, что указывает на успешную обработку и публикацию данных.

    <img alt="grafana_data_ingest" src="/../assets/img/grafana_data-ingest-test3.png" width="400"> 

    Если вы используете неправильный путь, вы увидите сообщение об ошибке в логах.

## Заключение

!!! success "Поздравляем!"
    В этом практическом занятии вы научились:

    - Запускать рабочий процесс wis2box, загружая данные в MinIO различными способами.
    - Отлаживать распространенные ошибки в процессе обработки данных с использованием панели мониторинга Grafana и логов вашей инстанции wis2box.
    - Мониторить уведомления WIS2 о данных, опубликованные вашей wis2box, через панель мониторинга Grafana и MQTT Explorer.