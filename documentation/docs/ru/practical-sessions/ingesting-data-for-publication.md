---
title: Загрузка данных для публикации
---

# Загрузка данных для публикации

!!! abstract "Результаты обучения"

    К концу этой практической сессии вы сможете:
    
    - Запускать рабочий процесс wis2box, загружая данные в MinIO с помощью командной строки, веб-интерфейса MinIO, SFTP или Python-скрипта.
    - Получать доступ к панели мониторинга Grafana для отслеживания статуса загрузки данных и просмотра логов вашей инстанции wis2box.
    - Просматривать уведомления WIS2 о данных, опубликованных вашей инстанцией wis2box, с помощью MQTT Explorer.

## Введение

В WIS2 данные распространяются в реальном времени с использованием уведомлений WIS2 о данных, которые содержат "каноническую" ссылку для загрузки данных.

Чтобы запустить рабочий процесс данных в узле WIS2 с использованием программного обеспечения wis2box, данные должны быть загружены в **корзину wis2box-incoming** в **MinIO**, что инициирует рабочий процесс wis2box. Этот процесс приводит к публикации данных через уведомление WIS2 о данных. В зависимости от настроек сопоставления данных в вашей инстанции wis2box данные могут быть преобразованы в формат BUFR перед публикацией.

В этом упражнении мы будем использовать примерные файлы данных для запуска рабочего процесса wis2box и **публикации уведомлений WIS2 о данных** для набора данных, который вы настроили в предыдущей практической сессии.

Во время выполнения упражнения мы будем отслеживать статус загрузки данных с помощью **панели мониторинга Grafana** и **MQTT Explorer**. Панель мониторинга Grafana использует данные из Prometheus и Loki для отображения статуса вашей инстанции wis2box, а MQTT Explorer позволяет видеть уведомления WIS2 о данных, опубликованные вашей инстанцией wis2box.

Обратите внимание, что wis2box преобразует примерные данные в формат BUFR перед их публикацией в брокере MQTT в соответствии с предварительно настроенными сопоставлениями данных в вашем наборе данных. В этом упражнении мы сосредоточимся на различных методах загрузки данных в вашу инстанцию wis2box и проверке успешности загрузки и публикации. Преобразование данных будет рассмотрено позже в практической сессии [Инструменты преобразования данных](./data-conversion-tools.md).

## Подготовка

В этом разделе используются два набора данных, подготовленных в практической сессии "Настройка наборов данных в wis2box":

1. Предопределенный набор данных weather/surface-based-observations/synop.

2. Пользовательский набор данных, созданный с использованием шаблона Other (пример GEPS).

Для загрузки данных **weather/surface-based-observations/synop** необходимо настроить метаданные станции в wis2box-webapp, как описано в практической сессии [Настройка метаданных станции](./configuring-station-metadata.md).

Для набора данных **other**, используемого в этом обучении, выбран универсальный плагин без преобразования данных для публикации файлов в формате GRIB2 без преобразования. Поскольку этот учебный набор данных не представляет собой наблюдения станций, настройка станции не требуется. Убедитесь, что расширение файла установлено как .grib2, а регулярное выражение для шаблона имени файла соответствует именам ваших данных.

Убедитесь, что вы можете войти в виртуальную машину студента (VM) с помощью вашего SSH-клиента (например, PuTTY).

Убедитесь, что wis2box запущен и работает:

```bash
cd ~/wis2box/
python3 wis2box-ctl.py start
python3 wis2box-ctl.py status
```

Убедитесь, что MQTT Explorer запущен и подключен к вашей инстанции, используя публичные учетные данные `everyone/everyone` с подпиской на тему `origin/a/wis2/#`.

Убедитесь, что у вас открыт веб-браузер с панелью мониторинга Grafana для вашей инстанции, перейдя по адресу `http://YOUR-HOST:3000`.

## Подготовка примерных данных

Скопируйте каталог `exercise-materials/data-ingest-exercises` в каталог, который вы определили как `WIS2BOX_HOST_DATADIR` в вашем файле `wis2box.env`:

```bash
cp -r ~/exercise-materials/data-ingest-exercises ~/wis2box-data/
```

!!! note
    `WIS2BOX_HOST_DATADIR` монтируется как `/data/wis2box/` внутри контейнера wis2box-management с помощью файла `docker-compose.yml`, включенного в каталог `wis2box`.
    
    Это позволяет обмениваться данными между хостом и контейнером.

## Добавление тестовой станции (только для данных наблюдений станций)

Давайте используем предопределенный набор данных weather/surface-based-observations/synop, который был создан ранее в практической сессии (./configuring-wis2box-datasdets.md), основанный на реальных наблюдениях станций.

Добавьте станцию с идентификатором WIGOS `0-20000-0-64400` в вашу инстанцию wis2box с помощью редактора станций в wis2box-webapp.

Получите данные станции из OSCAR:

<img alt="oscar-station" src="/../assets/img/webapp-test-station-oscar-search.png" width="600">

Добавьте станцию в наборы данных, которые вы создали для публикации на "../surface-based-observations/synop", и сохраните изменения, используя ваш токен аутентификации:

<img alt="webapp-test-station" src="/../assets/img/webapp-test-station-save.png" width="800">

Обратите внимание, что вы можете удалить эту станцию из вашего набора данных после завершения практической сессии.

## Тестирование загрузки данных из командной строки

В этом упражнении мы будем использовать команду `wis2box data ingest` для загрузки данных в MinIO.

Убедитесь, что вы находитесь в каталоге `wis2box`, и войдите в контейнер **wis2box-management**:

```bash
cd ~/wis2box
python3 wis2box-ctl.py login
```

Убедитесь, что примерные данные доступны в каталоге `/data/wis2box/` внутри контейнера **wis2box-management**:

```bash
ls -lh /data/wis2box/data-ingest-exercises/synop_202412030900.txt
```

!!! question "Загрузка данных с использованием `wis2box data ingest`"

    Выполните следующую команду для загрузки примерного файла данных в вашу инстанцию wis2box:

    ```bash
    wis2box data ingest -p /data/wis2box/data-ingest-exercises/synop_202412030900.txt --metadata-id urn:wmo:md:not-my-centre:synop-test
    ```

    Были ли данные успешно загружены? Если нет, какое сообщение об ошибке вы получили и как можно его исправить?

??? success "Нажмите, чтобы увидеть ответ"

    Данные **не** были успешно загружены. Вы должны увидеть следующее:

    ```bash
    Error: metadata_id=urn:wmo:md:not-my-centre:synop-test not found in data mappings
    ```

    Сообщение об ошибке указывает, что предоставленный вами идентификатор метаданных не соответствует ни одному из наборов данных, настроенных в вашей инстанции wis2box.

    Укажите правильный идентификатор метаданных, который соответствует набору данных, созданному вами в предыдущей практической сессии, и повторите команду загрузки данных, пока не увидите следующий вывод:

    ```bash 
    Processing /data/wis2box/data-ingest-exercises/synop_202412030900.txt
    Done
    ```

Перейдите в консоль MinIO в вашем браузере и проверьте, был ли файл `synop_202412030900.txt` загружен в корзину `wis2box-incoming`. Вы должны увидеть новый каталог с именем набора данных, который вы указали в опции `--metadata-id`, и внутри этого каталога будет находиться файл `synop_202412030900.txt`:

<img alt="minio-wis2box-incoming-dataset-folder" src="/../assets/img/minio-data-ingest-test-data.png" width="800">

!!! note
    Команда `wis2box data ingest` загрузила файл в корзину `wis2box-incoming` в MinIO в каталог, названный в соответствии с предоставленным вами идентификатором метаданных.

Перейдите на панель мониторинга Grafana в вашем браузере и проверьте статус загрузки данных.

!!! question "Проверка статуса загрузки данных в Grafana"
    
    Перейдите на панель мониторинга Grafana по адресу **http://your-host:3000** и проверьте статус загрузки данных в вашем браузере.
    
    Как можно определить, были ли данные успешно загружены и опубликованы?

??? success "Нажмите, чтобы увидеть ответ"
    
    Если вы успешно загрузили данные, вы должны увидеть следующее:
    
    <img alt="grafana_data_ingest" src="/../assets/img/grafana_data-ingest-test.png" width="400">  
    
    Если вы этого не видите, проверьте сообщения WARNING или ERROR, отображаемые в нижней части панели мониторинга, и попытайтесь их устранить.

!!! question "Проверка брокера MQTT на наличие уведомлений WIS2"
    
    Перейдите в MQTT Explorer и проверьте, можете ли вы увидеть сообщение уведомления WIS2 о данных, которые вы только что загрузили.
    
    Сколько уведомлений WIS2 о данных было опубликовано вашей инстанцией wis2box?
    
    Как можно получить доступ к содержимому публикуемых данных?

??? success "Нажмите, чтобы увидеть ответ"

    Вы должны увидеть 1 уведомление WIS2 о данных, опубликованное вашей инстанцией wis2box.

    Чтобы получить доступ к содержимому публикуемых данных, вы можете развернуть структуру темы, чтобы увидеть различные уровни сообщения, пока не дойдете до последнего уровня, и просмотреть содержимое сообщения.

Содержимое сообщения имеет раздел "links" с ключом "rel" со значением "canonical" и ключом "href", содержащим URL для загрузки данных. URL будет в формате `http://YOUR-HOST/data/...`.

Обратите внимание, что формат данных — BUFR, и для просмотра содержимого данных вам потребуется парсер BUFR. Формат BUFR — это бинарный формат, используемый метеорологическими службами для обмена данными. Плагины данных внутри wis2box преобразуют данные в BUFR перед их публикацией.

После завершения этого упражнения выйдите из контейнера **wis2box-management**:

```bash
exit
```

## Загрузка данных с использованием SFTP (опционально)

Сервис MinIO в wis2box также доступен через SFTP. SFTP-сервер для MinIO привязан к порту 8022 на хосте (порт 22 используется для SSH).

В этом упражнении мы продемонстрируем, как использовать WinSCP для загрузки данных в MinIO через SFTP.

Вы можете настроить новое соединение WinSCP, как показано на этом скриншоте:

<img alt="winscp-sftp-connection" src="/../assets/img/winscp-sftp-login.png" width="400">

Учетные данные для подключения через SFTP определяются переменными `WIS2BOX_STORAGE_USERNAME` и `WIS2BOX_STORAGE_PASSWORD` в вашем файле `wis2box.env` и совпадают с учетными данными, которые вы использовали для подключения к интерфейсу MinIO.

После входа вы увидите бакеты, используемые wis2box в MinIO:

<img alt="winscp-sftp-bucket" src="/../assets/img/winscp-buckets.png" width="600">

Вы можете перейти в бакет `wis2box-incoming`, а затем в папку для вашего набора данных. Вы увидите файлы, которые вы загрузили в предыдущих упражнениях:

<img alt="winscp-sftp-incoming-path" src="/../assets/img/winscp-incoming-data-path.png" width="600">

!!! question "Загрузка данных с использованием SFTP"

    Скачайте этот пример файла на ваш локальный компьютер:

    [synop_202503030900.txt](./../sample-data/synop_202503030900.txt) (щелкните правой кнопкой мыши и выберите "сохранить как", чтобы загрузить файл).

    Затем загрузите его в путь для входящих данных в MinIO, используя вашу SFTP-сессию в WinSCP.

    Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно обработаны и опубликованы.

??? success "Нажмите, чтобы увидеть ответ"

    Вы должны увидеть новое уведомление WIS2 о данных, опубликованное для тестовой станции `0-20000-0-64400`, указывающее, что данные были успешно обработаны и опубликованы.

    <img alt="grafana_data_ingest" src="/../assets/img/grafana_data-ingest-test3.png" width="400"> 

    Если вы используете неправильный путь, вы увидите сообщение об ошибке в логах.

## Загрузка данных с использованием Python-скрипта (опционально)

В этом упражнении мы используем клиент MinIO для Python, чтобы скопировать данные в MinIO.

MinIO предоставляет клиент для Python, который можно установить следующим образом:

```bash
pip3 install minio
```

На вашей учебной виртуальной машине пакет 'minio' для Python уже будет установлен.

В каталоге `exercise-materials/data-ingest-exercises` вы найдете пример скрипта `copy_file_to_incoming.py`, который можно использовать для копирования файлов в MinIO.

Попробуйте запустить скрипт, чтобы скопировать пример файла данных `synop_202501030900.txt` в бакет `wis2box-incoming` в MinIO следующим образом:

```bash
cd ~/wis2box-data/data-ingest-exercises
python3 copy_file_to_incoming.py synop_202501030900.txt
```

!!! note

    Вы получите ошибку, так как скрипт не настроен для доступа к MinIO на вашем wis2box.

Скрипту необходимо знать правильную конечную точку для доступа к MinIO на вашем wis2box. Если wis2box работает на вашем хосте, конечная точка MinIO доступна по адресу `http://YOUR-HOST:9000`. Скрипт также должен быть обновлен с вашим паролем для хранилища и путем в бакете MinIO для сохранения данных.

!!! question "Обновите скрипт и загрузите данные в формате CSV"
    
    Отредактируйте скрипт `copy_file_to_incoming.py`, чтобы устранить ошибки, используя один из следующих методов:
    - Через командную строку: используйте текстовый редактор `nano` или `vim` для редактирования скрипта.
    - Используя WinSCP: создайте новое соединение с протоколом File Protocol `SCP` и теми же учетными данными, что и ваш SSH-клиент. Перейдите в каталог `wis2box-data/data-ingest-exercises` и отредактируйте `copy_file_to_incoming.py` с помощью встроенного текстового редактора.
    
    Убедитесь, что вы:

    - Указали правильную конечную точку MinIO для вашего хоста.
    - Предоставили правильный пароль для вашего экземпляра MinIO.
    - Указали правильный путь в бакете MinIO для сохранения данных.

    Перезапустите скрипт, чтобы загрузить пример файла данных `synop_202501030900.txt` в MinIO:

    ```bash
    python3 ~/wis2box-data/ ~/wis2box-data/synop_202501030900.txt
    ```

    Убедитесь, что ошибки устранены.

После успешного выполнения скрипта вы увидите сообщение о том, что файл был скопирован в MinIO, и должны увидеть уведомления о данных, опубликованные вашим экземпляром wis2box в MQTT Explorer.

Вы также можете проверить панель мониторинга Grafana, чтобы убедиться, что данные были успешно обработаны и опубликованы.

Теперь, когда скрипт работает, вы можете попробовать скопировать другие файлы в MinIO, используя тот же скрипт.

!!! question "Загрузка бинарных данных в формате BUFR"

    Выполните следующую команду, чтобы скопировать бинарный файл данных `bufr-example.bin` в бакет `wis2box-incoming` в MinIO:

    ```bash
    python3 copy_file_to_incoming.py bufr-example.bin
    ```

Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что тестовые данные были успешно обработаны и опубликованы. Если вы видите ошибки, попробуйте их устранить.

!!! question "Проверьте загрузку данных"

    Сколько сообщений было опубликовано в MQTT брокер для этого примера данных?

??? success "Нажмите, чтобы увидеть ответ"

    Вы увидите ошибки в Grafana, так как станции в файле BUFR не определены в списке станций вашего экземпляра wis2box. 
    
    Если все станции, используемые в файле BUFR, определены в вашем экземпляре wis2box, вы должны увидеть 10 сообщений, опубликованных в MQTT брокер. Каждое уведомление соответствует данным для одной станции за один временной штамп наблюдения.

    Плагин `wis2box.data.bufr4.ObservationDataBUFR` разделяет файл BUFR на отдельные сообщения BUFR и публикует одно сообщение для каждой станции и временного штампа наблюдения.

## Загрузка данных с использованием веб-интерфейса MinIO 

В первых трех методах загрузки данных мы последовательно использовали набор данных, основанный на станциях (synop), и связанные с ним данные наблюдений. В этом разделе мы представим четвертый метод — один из наиболее часто используемых подходов. Здесь мы будем работать с другим набором данных и загружать данные GEPS с использованием веб-интерфейса MinIO, который позволяет загружать и скачивать данные напрямую через веб-браузер.

### Вход в браузер MinIO

Откройте веб-интерфейс MinIO (обычно доступен по адресу http://localhost:9001).

Учетные данные WIS2BOX_STORAGE_USERNAME и WIS2BOX_STORAGE_PASSWORD можно найти в файле wis2box.env.

### Перейдите в бакет wis2box-incoming

Выберите бакет wis2box-incoming и нажмите "Create new path". Имя директории должно соответствовать идентификатору метаданных вашего набора данных. Для этого обучения используйте ранее созданный набор данных GEPS, поэтому создайте директорию:

```bash
urn:wmo:md:nl-knmi-test:customized-geps-dataset-wis2-training
```

### Загрузка файлов данных GEPS

Войдите в только что созданную директорию, нажмите "Upload" и выберите локальные файлы данных GEPS для загрузки.

<img alt="minio-incoming-path" src="/../assets/img/minio-incoming-data-GEPS.png" width="800">

### Проверьте успешность загрузки с помощью MQTT Explorer

После загрузки проверьте с помощью MQTT Explorer, чтобы убедиться, что данные были успешно опубликованы.

Если публикация не удалась, проверьте следующее:

1. Убедитесь, что плагин был настроен для набора данных GEPS. Несоответствие между именем файла и настроенным регулярным выражением может помешать обработке. Отредактируйте регулярное выражение или переименуйте файлы данных, чтобы они соответствовали.

2. Перезапустите wis2box и повторите процесс загрузки.

После успешной публикации данных вы увидите сообщение с подтверждением, похожее на следующее:

<img alt="minio-incoming-path" src="/../assets/img/minio-incoming-data-path-publish.png" width="800">

!!! question "Повторная загрузка данных с использованием веб-интерфейса MinIO"

    Перейдите в веб-интерфейс MinIO в вашем браузере и откройте бакет `wis2box-incoming`. Вы увидите файл `Z_NAFP_C_BABJ_20250818000000_P_CMA-GEPS-GLB-024`, который вы загрузили в предыдущих упражнениях.

    Щелкните по файлу, и у вас появится возможность скачать его:

    <img alt="minio-wis2box-incoming-dataset-folder" src="/../assets/img/minio-download.png" width="800">

    Вы можете скачать этот файл и повторно загрузить его в тот же путь в MinIO, чтобы повторно запустить рабочий процесс wis2box.

Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно обработаны и опубликованы.

??? success "Нажмите, чтобы увидеть ответ"

Вы увидите сообщение, указывающее, что wis2box уже опубликовал эти данные:

```bash
ERROR - Data already published for Z_NAFP_C_BABJ_20250818000000_P_CMA-GEPS-GLB-024-grib2; not publishing
```

Это демонстрирует, что рабочий процесс обработки данных был запущен, но данные не были опубликованы повторно. wis2box не публикует одни и те же данные дважды.

Для **другого** набора данных:

## Заключение

!!! success "Поздравляем!"
В ходе этой практической сессии вы научились:

- Запускать рабочий процесс wis2box, загружая данные в MinIO различными способами.
- Отлаживать распространенные ошибки в процессе обработки данных, используя панель мониторинга Grafana и журналы вашей инстанции wis2box.
- Отслеживать уведомления WIS2 о данных, опубликованные вашим wis2box, на панели мониторинга Grafana и в MQTT Explorer.