---
title: Загрузка данных для публикации
---

# Загрузка данных для публикации

!!! abstract "Результаты обучения"

    К концу этой практической сессии вы сможете:
    
    - Запускать рабочий процесс wis2box, загружая данные в MinIO через веб-интерфейс MinIO, SFTP или Python-скрипт.
    - Получать доступ к панели мониторинга Grafana для отслеживания статуса загрузки данных и просмотра логов вашей инстанции wis2box.
    - Просматривать уведомления WIS2 о данных, опубликованных вашей инстанцией wis2box, с помощью MQTT Explorer.

## Введение

В WIS2 данные передаются в реальном времени с использованием уведомлений WIS2 о данных, которые содержат "каноническую" ссылку, по которой можно загрузить данные.

Чтобы запустить рабочий процесс данных в узле WIS2 с использованием программного обеспечения wis2box, данные должны быть загружены в **корзину wis2box-incoming** в **MinIO**, что инициирует рабочий процесс wis2box. Этот процесс приводит к публикации данных через уведомление WIS2 о данных. В зависимости от настроек отображения данных в вашей инстанции wis2box данные могут быть преобразованы в формат BUFR перед публикацией.

В этом упражнении мы будем использовать пример файлов данных для запуска рабочего процесса wis2box и **публикации уведомлений WIS2 о данных** для набора данных, который вы настроили в предыдущей практической сессии.

Во время упражнения мы будем отслеживать статус загрузки данных с помощью **панели мониторинга Grafana** и **MQTT Explorer**. Панель мониторинга Grafana использует данные из Prometheus и Loki для отображения статуса вашей инстанции wis2box, а MQTT Explorer позволяет видеть уведомления WIS2 о данных, опубликованные вашей инстанцией wis2box.

Обратите внимание, что wis2box преобразует пример данных в формат BUFR перед их публикацией в брокере MQTT в соответствии с предварительно настроенными отображениями данных в вашем наборе данных. В этом упражнении мы сосредоточимся на различных методах загрузки данных в вашу инстанцию wis2box и проверке успешной загрузки и публикации. Преобразование данных будет рассмотрено позже в практической сессии [Инструменты преобразования данных](./data-conversion-tools.md).

## Подготовка

Этот раздел использует набор данных для "surface-based-observations/synop" и "other", созданный ранее в практической сессии [Настройка наборов данных в wis2box](./configuring-wis2box-datasets.md). 

Также требуется знание настройки станций в **wis2box-webapp**, как описано в практической сессии [Настройка метаданных станции](./configuring-station-metadata.md).

Убедитесь, что вы можете войти в свою виртуальную машину студента, используя SSH-клиент (например, PuTTY).

Убедитесь, что wis2box запущен:

```bash
cd ~/wis2box/
python3 wis2box-ctl.py start
python3 wis2box-ctl.py status
```

Убедитесь, что MQTT Explorer запущен и подключен к вашей инстанции с использованием публичных учетных данных `everyone/everyone` с подпиской на тему `origin/a/wis2/#`.

Убедитесь, что у вас открыт веб-браузер с панелью мониторинга Grafana для вашей инстанции, перейдя по адресу `http://YOUR-HOST:3000`.

### Подготовка примерных данных

Скопируйте каталог `exercise-materials/data-ingest-exercises` в каталог, который вы определили как `WIS2BOX_HOST_DATADIR` в вашем файле `wis2box.env`:

```bash
cp -r ~/exercise-materials/data-ingest-exercises ~/wis2box-data/
```

!!! note
    `WIS2BOX_HOST_DATADIR` монтируется как `/data/wis2box/` внутри контейнера wis2box-management с помощью файла `docker-compose.yml`, включенного в каталог `wis2box`.
    
    Это позволяет обмениваться данными между хостом и контейнером.

## Загрузка данных с использованием интерфейса MinIO

Сначала мы будем использовать веб-интерфейс MinIO, который позволяет загружать и скачивать данные в MinIO через веб-браузер.

### Доступ к интерфейсу MinIO

Откройте веб-интерфейс MinIO (обычно доступен по адресу http://your-localhost:9001).

Учетные данные WIS2BOX_STORAGE_USERNAME и WIS2BOX_STORAGE_PASSWORD можно найти в файле wis2box.env.

### Загрузка и публикация с использованием универсального плагина

Скачайте универсальные примерные данные для этого упражнения по следующей ссылке в вашем локальном окружении:
[sample-data-for-universal-plugin](../sample-data/Z_NAFP_C_BABJ_20250818000000_P_CMA-GEPS-GLB-024.grib2)

Выберите корзину wis2box-incoming и нажмите "Create new path". Имя каталога должно соответствовать идентификатору метаданных вашего набора данных "other", который вы создали ранее в практической сессии [Настройка наборов данных в wis2box](./configuring-wis2box-datasets.md). В данном случае создайте каталог:

```bash
urn:wmo:md:nl-knmi-test:customized-geps-dataset-wis2-training
```

Перейдите в только что созданный каталог, нажмите "Upload" и выберите файл [sample-data-for-universal-plugin](../sample-data/Z_NAFP_C_BABJ_20250818000000_P_CMA-GEPS-GLB-024.grib2), который вы скачали на свой локальный компьютер.

После загрузки проверьте с помощью MQTT Explorer, чтобы убедиться, что данные были успешно опубликованы.

<img alt="Редактор метаданных: заголовок, описание, ключевые слова" src="/../assets/img/mqtt-explorer-wis2-notification-geps-sample.png" width="800">

!!! question "Переименуйте файл в sample-geps-data.grib2"

    Загрузите переименованный файл с помощью веб-интерфейса в тот же путь в MinIO, что и предыдущий файл.

    Будет ли переименованный файл успешно опубликован? Почему или почему нет?

??? success "Нажмите, чтобы увидеть ответ"

    Нет, потому что при изменении имени файла на "sample-geps-data.grib2" он не будет соответствовать правилу регулярного выражения.

    <img alt="Редактор метаданных: заголовок, описание, ключевые слова" src="/../assets/img/mqtt-explorer-wis2-notification-geps-regex-error.png" width="800">
    
    При загрузке данных имена файлов должны соответствовать требуемой схеме именования, определенной регулярным выражением:

    ```bash
    ^.*?_(\d{8}).*?\..*$
    ```

    Этот шаблон требует, чтобы имя файла содержало:

    Подчеркивание (_), за которым сразу следует 8-значная строка даты в формате ГГГГММДД (например, 20250904).

    Например, следующие имена являются допустимыми:

    1. *Z_NAFP_C_BABJ_20250904_P_CMA-GEPS-GLB-024.grib2*

    2. *forecast_20250904.grib2*

    3. *sample-geps_20250101_data.grib2*

    Имя, такое как sample-geps-data.grib2, не будет принято, так как оно не содержит требуемой 8-значной даты.

!!! question "Измените расширение файла с .grib2 на .bufr4 (без изменения внутреннего содержимого файла)"

    Загрузите файл с измененным расширением с помощью веб-интерфейса в тот же путь в MinIO, что и предыдущий файл.

    Будет ли файл с измененным расширением успешно опубликован? Почему или почему нет?

??? success "Нажмите, чтобы увидеть ответ"

    Нет, потому что при изменении формата данных с "grib2" на "bufr4" он не будет соответствовать правилу расширения файла, определенному при создании этого набора данных.

    <img alt="Редактор метаданных: заголовок, описание, ключевые слова" src="/../assets/img/mqtt-explorer-wis2-notification-geps-file-extension-error.png" width="800">
    
    При загрузке данных с использованием универсального плагина файл должен иметь правильное расширение, как определено в конфигурации набора данных. Это требование гарантирует, что процесс загрузки сможет правильно распознать и обработать формат файла. Например, если набор данных настроен для файлов формата grib2, будут приняты только файлы с расширением .grib2. Использование неправильного расширения (например, .txt или .bin) приведет к отклонению файла и его непубликации.

!!! question "Повторная загрузка данных с использованием веб-интерфейса MinIO"

    Перейдите в веб-интерфейс MinIO в вашем браузере и откройте корзину `wis2box-incoming`. Вы увидите файл `Z_NAFP_C_BABJ_20250818000000_P_CMA-GEPS-GLB-024.grib2`, который вы загрузили в предыдущих упражнениях.

    Нажмите на файл, и у вас будет возможность скачать его:

    <img alt="Каталог набора данных в MinIO" src="/../assets/img/minio-download.png" width="800">

    Вы можете скачать этот файл и повторно загрузить его в тот же путь в MinIO, чтобы повторно запустить рабочий процесс wis2box.

    Проверьте панель мониторинга Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно загружены и опубликованы.

??? success "Нажмите, чтобы увидеть ответ"

    Вы увидите сообщение, указывающее, что wis2box уже опубликовал эти данные:

    ```bash
    ERROR - Data already published for Z_NAFP_C_BABJ_20250818000000_P_CMA-GEPS-GLB-024-grib2; not publishing
    ``` 
    
    Это демонстрирует, что рабочий процесс данных был запущен, но данные не были повторно опубликованы. Wis2box не публикует одни и те же данные дважды.

### Загрузка и публикация с использованием плагина synop2bufr-plugin

Скачайте пример данных synop [synop_202502040900.txt](../sample-data/synop_202502040900.txt) для этого упражнения по ссылке ниже в вашу локальную среду:

Выберите bucket `wis2box-incoming` и нажмите "Create new path". Имя директории должно соответствовать идентификатору метаданных вашего набора данных "surface-based-observations/synop", который вы ранее создали в практическом занятии [Configuring Datasets in wis2box](./configuring-wis2box-datasets.md). Таким образом, создайте директорию:

```bash
urn:wmo:md:nl-knmi-test:synop-dataset-wis2-training
```

Перейдите в только что созданную директорию, нажмите "Upload", выберите файл [synop_202502040900.txt](../sample-data/synop_202502040900.txt), который вы скачали на свой локальный компьютер, и загрузите его.

!!! question "Вы получили новое уведомление о том, что данные были опубликованы? Почему?"

??? success "Нажмите, чтобы раскрыть ответ"

    Нет. В Grafana Dashboard вы увидите ошибку, указывающую на то, что загрузка данных не удалась:

    <img alt="grafana_data_ingest" src="/../assets/img/grafana_data-ingest-error.png" width="800"> 

    При использовании шаблона набора данных synop с плагинами по умолчанию для данных SYNOP (CSV, TXT и BUFR), каждая запись должна содержать корректный идентификатор станции. Загрузка данных завершается с ошибкой, если станция не известна вашей инстанции `wis2box`. Поэтому сначала необходимо добавить станцию перед публикацией данных SYNOP.

    Теперь добавим тестовую станцию для этого упражнения.

Добавьте станцию с идентификатором WIGOS `0-20000-0-64400` в вашу инстанцию `wis2box`, используя редактор станций в `wis2box-webapp`.

Получите данные станции из OSCAR:

<img alt="oscar-station" src="/../assets/img/webapp-test-station-oscar-search.png" width="600">

Добавьте станцию в наборы данных, которые вы создали для публикации в "../surface-based-observations/synop", и сохраните изменения, используя ваш токен аутентификации:

<img alt="webapp-test-station" src="/../assets/img/webapp-test-station-save.png" width="800">

Обратите внимание, что вы можете удалить эту станцию из вашего набора данных после завершения практического занятия.

После завершения настройки метаданных станции проверьте с помощью MQTT Explorer, что данные были успешно опубликованы. Если вы увидите уведомление ниже, значит, вы успешно опубликовали пример данных synop.

<img alt="webapp-test-station" src="/../assets/img/mqtt-explorer-wis2box-notification-synop-sample.png" width="800">

## Загрузка данных с использованием Python (опционально)

В этом упражнении мы используем Python-клиент MinIO для копирования данных в MinIO.

MinIO предоставляет Python-клиент, который можно установить следующим образом:

```bash
pip3 install minio
```

На вашей виртуальной машине для студентов пакет 'minio' для Python уже установлен.

В директории `exercise-materials/data-ingest-exercises` вы найдете пример скрипта `copy_file_to_incoming.py`, который можно использовать для копирования файлов в MinIO.

Попробуйте запустить скрипт, чтобы скопировать файл с примером данных `synop_202501030900.txt` в bucket `wis2box-incoming` в MinIO следующим образом:

```bash
cd ~/wis2box-data/data-ingest-exercises
python3 copy_file_to_incoming.py synop_202501030900.txt
```

!!! note

    Вы получите ошибку, так как скрипт не настроен для доступа к MinIO на вашей инстанции `wis2box`.

Скрипту необходимо знать правильный endpoint для доступа к MinIO на вашей инстанции `wis2box`. Если `wis2box` работает на вашем хосте, endpoint MinIO доступен по адресу `http://YOUR-HOST:9000`. Также скрипт должен быть обновлен с вашим паролем для хранилища и путем в bucket MinIO для сохранения данных.

!!! question "Обновите скрипт и загрузите данные CSV"
    
    Отредактируйте скрипт `copy_file_to_incoming.py`, чтобы устранить ошибки, используя один из следующих методов:
    - Через командную строку: используйте текстовый редактор `nano` или `vim` для редактирования скрипта.
    - С помощью WinSCP: установите новое соединение, используя File Protocol `SCP` и те же учетные данные, что и для вашего SSH-клиента. Перейдите в директорию `wis2box-data/data-ingest-exercises` и отредактируйте `copy_file_to_incoming.py`, используя встроенный текстовый редактор.

    Убедитесь, что вы:

    - Указали правильный endpoint MinIO для вашего хоста.
    - Предоставили корректный пароль для хранилища MinIO.
    - Указали правильный путь в bucket MinIO для сохранения данных.

    Перезапустите скрипт, чтобы загрузить файл с примером данных `synop_202501030900.txt` в MinIO:

    ```bash
    python3 ~/wis2box-data/ ~/wis2box-data/synop_202501030900.txt
    ```

    Убедитесь, что ошибки устранены.

После успешного выполнения скрипта вы увидите сообщение о том, что файл был скопирован в MinIO, и должны увидеть уведомления о данных, опубликованных вашей инстанцией `wis2box`, в MQTT Explorer.

Вы также можете проверить панель Grafana, чтобы убедиться, что данные были успешно загружены и опубликованы.

Теперь, когда скрипт работает, вы можете попробовать скопировать другие файлы в MinIO, используя тот же скрипт.

!!! question "Загрузка бинарных данных в формате BUFR"

    Выполните следующую команду, чтобы скопировать бинарный файл данных `bufr-example.bin` в bucket `wis2box-incoming` в MinIO:

    ```bash
    python3 copy_file_to_incoming.py bufr-example.bin
    ```

Проверьте панель Grafana и MQTT Explorer, чтобы убедиться, что тестовые данные были успешно загружены и опубликованы. Если вы увидите ошибки, попробуйте их устранить.

!!! question "Проверка загрузки данных"

    Сколько сообщений было опубликовано в брокер MQTT для этого примера данных?

??? success "Нажмите, чтобы раскрыть ответ"

    Вы увидите ошибки, указанные в Grafana, так как станции в файле BUFR не определены в списке станций вашей инстанции `wis2box`. 
    
    Если все станции, используемые в файле BUFR, определены в вашей инстанции `wis2box`, вы должны увидеть 10 сообщений, опубликованных в брокер MQTT. Каждое уведомление соответствует данным для одной станции за один временной штамп наблюдения.

    Плагин `wis2box.data.bufr4.ObservationDataBUFR` разделяет файл BUFR на отдельные сообщения BUFR и публикует одно сообщение для каждой станции и временного штампа наблюдения.

## Загрузка данных через SFTP (опционально)

Сервис MinIO в `wis2box` также может быть доступен через SFTP. SFTP-сервер для MinIO привязан к порту 8022 на хосте (порт 22 используется для SSH).

В этом упражнении мы продемонстрируем, как использовать WinSCP для загрузки данных в MinIO через SFTP.

Вы можете настроить новое соединение WinSCP, как показано на этом скриншоте:

<img alt="winscp-sftp-connection" src="/../assets/img/winscp-sftp-login.png" width="400">

Учетные данные для подключения через SFTP определяются переменными `WIS2BOX_STORAGE_USERNAME` и `WIS2BOX_STORAGE_PASSWORD` в вашем файле `wis2box.env` и совпадают с учетными данными, которые вы использовали для подключения к интерфейсу MinIO.

После входа вы увидите buckets, используемые `wis2box` в MinIO:

<img alt="winscp-sftp-bucket" src="/../assets/img/winscp-buckets.png" width="600">

Вы можете перейти в bucket `wis2box-incoming`, а затем в папку для вашего набора данных. Вы увидите файлы, которые вы загрузили в предыдущих упражнениях:

<img alt="winscp-sftp-incoming-path" src="/../assets/img/winscp-incoming-data-path.png" width="600">

!!! question "Загрузка данных через SFTP"

    Скачайте этот пример файла на ваш локальный компьютер:

    [synop_202503030900.txt](./../sample-data/synop_202503030900.txt) (щелкните правой кнопкой мыши и выберите "сохранить как", чтобы скачать файл).

    Затем загрузите его в путь набора данных в MinIO, используя вашу SFTP-сессию в WinSCP.

    Проверьте панель Grafana и MQTT Explorer, чтобы убедиться, что данные были успешно загружены и опубликованы.

??? success "Нажмите, чтобы раскрыть ответ"

    Вы должны увидеть новое уведомление WIS2 о данных, опубликованное для тестовой станции `0-20000-0-64400`, что указывает на успешную загрузку и публикацию данных.

    <img alt="grafana_data_ingest" src="/../assets/img/grafana_data-ingest-test3.png" width="400"> 

    Если вы используете неправильный путь, вы увидите сообщение об ошибке в логах.

## Заключение

!!! success "Поздравляем!"
    В этом практическом занятии вы научились:

    - Запускать рабочий процесс `wis2box` путем загрузки данных в MinIO различными методами.
    - Отлаживать распространенные ошибки в процессе загрузки данных с использованием панели Grafana и логов вашей инстанции `wis2box`.
    - Мониторить уведомления WIS2 о данных, опубликованных вашей инстанцией `wis2box`, в панели Grafana и MQTT Explorer.