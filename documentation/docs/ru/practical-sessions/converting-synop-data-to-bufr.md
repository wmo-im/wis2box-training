---
title: Преобразование данных SYNOP в BUFR
---

# Преобразование данных SYNOP в BUFR из командной строки

!!! abstract "Учебные результаты"
    К концу этого практического занятия вы сможете:

    - использовать инструмент synop2bufr для преобразования отчётов FM-12 SYNOP в BUFR;
    - диагностировать и исправлять простые ошибки кодирования в отчётах FM-12 SYNOP перед преобразованием формата;

## Введение

Поверхностные метеорологические отчёты с наземных станций исторически сообщались ежечасно или в основные 
(00, 06, 12 и 18 UTC) и промежуточные (03, 09, 15, 21 UTC) синоптические часы. До перехода
на BUFR эти отчёты кодировались в виде простого текста в форме кода FM-12 SYNOP. Несмотря на то, что переход на BUFR
был запланирован к завершению к 2012 году, большое количество отчётов всё ещё обменивается в устаревшем 
формате FM-12 SYNOP. Дополнительную информацию о формате FM-12 SYNOP можно найти в Руководстве ВМО по кодам, 
Том I.1 (ВМО-№ 306, Том I.1).

[WMO Manual on Codes, Volume I.1](https://library.wmo.int/records/item/35713-manual-on-codes-international-codes-volume-i-1)

Для облегчения завершения перехода на BUFR были разработаны некоторые инструменты для
кодирования отчётов FM-12 SYNOP в BUFR, на этом занятии вы научитесь использовать эти инструменты, а также узнаете о связи между информацией, содержащейся в отчётах FM-12 SYNOP, и сообщениями BUFR.

## Подготовка

!!! warning "Предварительные требования"

    - Убедитесь, что ваш wis2box настроен и запущен.
    - Подтвердите статус, посетив API wis2box (``http://<your-host-name>/oapi``) и проверив, что API работает.
    - Обязательно прочтите разделы **synop2bufr primer** и **ecCodes primer** перед началом упражнений.

## synop2bufr primer

Ниже приведены основные команды и конфигурации `synop2bufr`:

### transform
Функция `transform` преобразует сообщение SYNOP в BUFR:

```bash
synop2bufr data transform --metadata my_file.csv --output-dir ./my_directory --year message_year --month message_month my_SYNOP.txt
```

Обратите внимание, что если параметры metadata, output directory, year и month не указаны, они примут свои значения по умолчанию:

| Параметр      | Значение по умолчанию |
| ----------- | ----------- |
| --metadata | station_list.csv |
| --output-dir | Текущая рабочая директория. |
| --year | Текущий год. |
| --month | Текущий месяц. |

!!! note
    Следует быть осторожным при использовании года и месяца по умолчанию, так как день месяца, указанный в отчёте, может не совпадать (например, у июня нет 31 дня).

В примерах год и месяц не указаны, поэтому не стесняйтесь указать дату самостоятельно или использовать значения по умолчанию.

## ecCodes primer

ecCodes предоставляет как инструменты командной строки, так и может быть встроен в ваши собственные приложения. Ниже приведены некоторые полезные командные
утилиты для работы с данными BUFR.

### bufr_dump

Команда `bufr_dump` является универсальным инструментом информации BUFR. У неё много опций, но следующие будут наиболее применимы к упражнениям:

```bash
bufr_dump -p my_bufr.bufr4
```

Это покажет содержимое BUFR на вашем экране. Если вас интересуют значения, принимаемые конкретной переменной, используйте команду `egrep`:

```bash
bufr_dump -p my_bufr.bufr4 | egrep -i temperature
```

Это покажет переменные, связанные с температурой в вашем BUFR-данных. Если вы хотите сделать это для нескольких типов переменных, отфильтруйте вывод с помощью канала (`|`):

```bash
bufr_dump -p my_bufr.bufr4 | egrep -i 'temperature|wind'
```

## Преобразование FM-12 SYNOP в BUFR с использованием synop2bufr из командной строки

Библиотека eccodes и модуль synop2bufr установлены в контейнере wis2box-api. Чтобы выполнить следующие несколько упражнений, мы скопируем каталог synop2bufr-exercises в контейнер wis2box-api и выполним упражнения оттуда.

```bash
docker cp ~/exercise-materials/synop2bufr-exercises wis2box-api:/root
```

Теперь мы можем войти в контейнер и выполнить упражнения:

```bash
docker exec -it wis2box-api /bin/bash
```

### Упражнение 1
Перейдите в каталог `/root/synop2bufr-exercises/ex_1` и изучите файл сообщения SYNOP message.txt:

```bash
cd /root/synop2bufr-exercises/ex_1
more message.txt
```

!!! question

    Сколько отчётов SYNOP содержится в этом файле?

??? success "Нажмите, чтобы увидеть ответ"
    
    В этом файле содержится 1 отчёт SYNOP, так как в конце сообщения есть только один разделитель (=).

Изучите список станций:

```bash
more station_list.csv
```

!!! question

    Сколько станций перечислено в списке станций?

??? success "Нажмите, чтобы увидеть ответ"

    В списке станций перечислена 1 станция, файл station_list.csv содержит одну строку с метаданными станции.

!!! question
    Попробуйте преобразовать `message.txt` в формат BUFR.

??? success "Нажмите, чтобы увидеть ответ"

    Для преобразования сообщения SYNOP в формат BUFR используйте следующую команду:

    ```bash
    synop2bufr data transform --metadata station_list.csv --output-dir ./ --year 2024 --month 09 message.txt
    ```

!!! tip

    См. раздел [synop2bufr primer](#synop2bufr-primer).

Изучите полученные данные BUFR с помощью `bufr_dump`.

!!! question
     Узнайте, как сравнить значения широты и долготы с теми, которые указаны в списке станций.

??? success "Нажмите, чтобы увидеть ответ"

    Для сравнения значений широты и долготы в данных BUFR с теми, которые указаны в списке станций, используйте следующую команду:

    ```bash
    bufr_dump -p WIGOS_0-20000-0-15015_20240921T120000.bufr4 | egrep -i 'latitude|longitude'
    ```

    Это покажет значения широты и долготы в данных BUFR.

!!! tip

    См. раздел [ecCodes primer](#eccodes-primer).

### Упражнение 2
Перейдите в каталог `exercise-materials/synop2bufr-exercises/ex_2` и изучите файл сообщения SYNOP message.txt:

```bash
cd /root/synop2bufr-exercises/ex_2
more message.txt
```

!!! question

    Сколько отчётов SYNOP содержится в этом файле?

??? success "Нажмите, чтобы увидеть ответ"

    В этом файле содержится 3 отчёта SYNOP, так как в конце сообщения есть 3 разделителя (=).

Изучите список станций:

```bash
more station_list.csv
```

!!! question

    Сколько станций перечислено в списке станций?

??? success "Нажмите, чтобы увидеть ответ"

    В списке станций перечислено 3 станции, файл station_list.csv содержит три строки с метаданными станций.

!!! question
    Преобразуйте `message.txt` в формат BUFR.

??? success "Нажмите, чтобы увидеть ответ"

    Для преобразования сообщения SYNOP в формат BUFR используйте следующую команду:

    ```bash
    synop2bufr data transform --metadata station_list.csv --output-dir ./ --year 2024 --month 09 message.txt
    ```

!!! question

    Основываясь на результатах упражнений в этом и предыдущем упражнении, как бы вы предсказали количество
    полученных файлов BUFR на основе количества отчётов SYNOP и станций, перечисленных в файле метаданных станций?

??? success "Нажмите, чтобы увидеть ответ"

    Чтобы увидеть произведённые файлы BUFR, выполните следующую команду:

    ```bash
    ls -l *.bufr4
    ```

    Количество произведённых файлов BUFR будет равно количеству отчётов SYNOP в файле сообщения.

Изучите полученные данные BUFR с помощью `bufr_dump`.

!!! question
    Как можно проверить код станции WIGOS, закодированный внутри данных BUFR каждого произведённого файла?

??? success "Нажмите, чтобы увидеть ответ"

    Это можно сделать с помощью следующих команд:

    ```bash
    bufr_dump -p WIGOS_0-20000-0-15015_20240921T120000.bufr4 | egrep -i 'wigos'
    ```

    ```bash
    bufr_dump -p WIGOS_0-20000-0-15020_20240921T120000.bufr4 | egrep -i 'wigos'
    ```

    ```bash
    bufr_dump -p WIGOS_0-20000-0-15090_20240921T120000.bufr4 | egrep -i 'wigos'
    ```

    Обратите внимание, что если у вас в каталоге только эти 3 файла BUFR, вы можете использовать подстановочные знаки Linux следующим образом:

    ```bash
    bufr_dump -p *.bufr4 | egrep -i 'wigos'
    ```

### Упражнение 3
Перейдите в каталог `exercise-materials/synop2bufr-exercises/ex_3` и изучите файл сообщения SYNOP message.txt:

```bash
cd /root/synop2bufr-exercises/ex_3
more message.txt
```

Это сообщение SYNOP содержит только один более длинный отчёт с несколькими разделами.

Изучите список станций:

```bash
more station_list.csv
```

!!! question

    Проблематично ли, что в этом файле больше станций, чем отчётов в сообщении SYNOP?

??? success "Нажмите, чтобы увидеть ответ"

    Нет, это не проблема, если в файле списка станций существует строка с TSI станции, соответствующей той, которую мы пытаемся преобразовать.

!!! note

    Файл списка станций является источником метаданных для `synop2bufr`, чтобы предоставить информацию, отсутствующую в алфавитно-цифровом отчёте SYNOP и требуемую в BUFR SYNOP.

!!! question
    Преобразуйте `message.txt` в формат BUFR.

??? success "Нажмите, чтобы увидеть ответ"

    Это делается с помощью команды `transform`, например:

    ```bash
    synop2bufr data transform --metadata station_list.csv --output-dir ./ --year 2024 --month 09 message.txt
    ```

Изучите полученные данные BUFR с помощью `bufr_dump`.

!!! question

    Найдите следующие переменные:

    - Температура воздуха (K) отчёта
    - Общее облачное покрытие (%) отчёта
    - Общее время солнечного света (мин) отчёта
    - Скорость ветра (м/с) отчёта

??? success "Нажмите, чтобы увидеть ответ"

    Чтобы найти переменные по ключевым словам в данных BUFR, вы можете использовать следующие команды:

    ```bash
    bufr_dump -p WIGOS_0-20000-0-15260_20240921T115500.bufr4 | egrep -i 'temperature'
    ```

    Вы можете использовать следующую команду для поиска нескольких ключевых слов:

    ```bash
    bufr_dump -p WIGOS_0-20000-0-15260_20240921T115500.bufr4 | egrep -i 'temperature|cover|sunshine|wind'
    ```

!!! tip

    Вам может быть полезна последняя команда из раздела [ecCodes primer](#eccodes-primer).


### Упражнение 4
Перейдите в каталог `exercise-materials/synop2bufr-exercises/ex_4` и изучите файл сообщения SYNOP message.txt:

```bash
cd /root/synop2bufr-exercises/ex_4
more message_incorrect.txt
```

!!! question

    Что неправильно в этом файле SYNOP?

??? success "Нажмите, чтобы увидеть ответ"

    В отчёте SYNOP для 15015 отсутствует разделитель (`=`), который позволяет `synop2bufr` различать этот отчёт от следующего.

Попытайтесь преобразовать `message_incorrect.txt` с использованием `station_list.csv`

!!! question

    С какими проблемами вы столкнулись при этом преобразовании?

??? success "Нажмите, чтобы увидеть ответ"

    Для преобразования сообщения SYNOP в формат BUFR используйте следующую команду:

    ```bash
    synop2bufr data transform --metadata station_list.csv --output-dir ./ --year 2024 --month 09 message_incorrect.txt
    ```

    Попытка преобразования должна вызвать следующие ошибки:
    
    - `[ERROR] Невозможно декодировать сообщение SYNOP`
    - `[ERROR] Ошибка разбора отчёта SYNOP: AAXX 21121 15015 02999 02501 101