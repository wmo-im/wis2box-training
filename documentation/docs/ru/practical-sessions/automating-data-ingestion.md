---
title: Автоматизация загрузки данных
---

# Автоматизация загрузки данных

!!! abstract "Учебные результаты"

    К концу этой практической сессии вы сможете:
    
    - понять, как плагины данных вашего набора данных определяют рабочий процесс загрузки данных
    - загружать данные в wis2box с помощью скрипта, используя клиент Python MinIO
    - загружать данные в wis2box, получая доступ к MinIO через SFTP

## Введение

Контейнер **wis2box-management** прослушивает события от службы хранения MinIO для запуска загрузки данных на основе настроенных плагинов данных для вашего набора данных. Это позволяет вам загружать данные в корзину MinIO и запускать рабочий процесс wis2box для публикации данных на брокере WIS2.

Плагины данных определяют модули Python, которые загружаются контейнером **wis2box-management** и определяют, как данные трансформируются и публикуются.

На предыдущем занятии вы должны были создать набор данных с использованием шаблона `surface-based-observations/synop`, который включал следующие плагины данных:

<img alt="сопоставления данных" src="/../assets/img/wis2box-data-mappings.png" width="800">

Когда файл загружается в MinIO, wis2box сопоставляет файл с набором данных, если путь к файлу содержит идентификатор набора данных (`metadata_id`), и определяет плагины данных, которые будут использоваться, на основе расширения файла и шаблона файла, определенного в сопоставлениях набора данных.

На предыдущих занятиях мы запускали рабочий процесс загрузки данных с помощью командной строки wis2box, которая загружает данные в хранилище MinIO в правильный путь.

Те же шаги можно выполнить программно, используя любое программное обеспечение-клиент MinIO или S3, что позволяет автоматизировать загрузку данных как часть ваших операционных рабочих процессов.

Кроме того, вы также можете получить доступ к MinIO, используя протокол SFTP для загрузки данных и запуска рабочего процесса загрузки данных.

## Подготовка

Войдите в свою студенческую виртуальную машину, используя ваш SSH-клиент (PuTTY или другой).

Убедитесь, что wis2box работает:

```bash
cd ~/wis2box-1.0.0rc1/
python3 wis2box-ctl.py start
python3 wis2box-ctl.py status
```

Убедитесь, что MQTT Explorer запущен и подключен к вашему экземпляру. Если вы все еще подключены с предыдущего занятия, очистите любые предыдущие сообщения, которые вы могли получить из очереди.
Это можно сделать, отключившись и снова подключившись или нажав значок мусорной корзины для данной темы.

Убедитесь, что у вас открыт веб-браузер с панелью управления Grafana для вашего экземпляра, перейдя по адресу `http://<ваш-хост>:3000`

И убедитесь, что у вас открыта вторая вкладка с пользовательским интерфейсом MinIO по адресу `http://<ваш-хост>:9001`. Помните, что вам нужно войти с использованием `WIS2BOX_STORAGE_USER` и `WIS2BOX_STORAGE_PASSWORD`, определенных в вашем файле `wis2box.env`.

## Упражнение 1: настройка Python-скрипта для загрузки данных в MinIO

В этом упражнении мы будем использовать клиент Python MinIO для копирования данных в MinIO.

MinIO предоставляет клиент Python, который можно установить следующим образом:

```bash
pip3 install minio
```

На вашей студенческой виртуальной машине пакет 'minio' для Python уже будет установлен.

Перейдите в каталог `exercise-materials/data-ingest-exercises`; этот каталог содержит пример скрипта `copy_file_to_incoming.py`, который использует клиент Python MinIO для копирования файла в MinIO.

Попробуйте запустить скрипт, чтобы скопировать образец данных файла `csv-aws-example.csv` в корзину `wis2box-incoming` в MinIO следующим образом:

```bash
cd ~/exercise-materials/data-ingest-exercises
python3 copy_file_to_incoming.py csv-aws-example.csv
```

!!! note

    Вы получите ошибку, так как скрипт еще не настроен для доступа к конечной точке MinIO на вашем wis2box.

Скрипту необходимо знать правильную конечную точку для доступа к MinIO на вашем wis2box. Если wis2box работает на вашем хосте, конечная точка MinIO доступна по адресу `http://<ваш-хост>:9000`. Скрипт также необходимо обновить с вашим паролем хранения и путем в корзине MinIO для хранения данных.

!!! question "Обновите скрипт и загрузите данные CSV"
    
    Отредактируйте скрипт `copy_file_to_incoming.py`, чтобы устранить ошибки, используя один из следующих методов:
    - Из командной строки: используйте текстовый редактор `nano` или `vim` для редактирования скрипта
    - Используя WinSCP: начните новое подключение с использованием протокола файлов `SCP` и тех же учетных данных, что и ваш SSH-клиент. Перейдите в каталог `exercise-materials/data-ingest-exercises` и отредактируйте `copy_file_to_incoming.py` с помощью встроенного текстового редактора
    
    Убедитесь, что вы:

    - определили правильную конечную точку MinIO для вашего хоста
    - предоставили правильный пароль хранения для вашего экземпляра MinIO
    - указали правильный путь в корзине MinIO для хранения данных

    Перезапустите скрипт для загрузки образца данных файла `csv-aws-example.csv` в MinIO:

    ```bash
    python3 copy_file_to_incoming.py csv-aws-example.csv
    ```

    И убедитесь, что ошибки устранены.

Вы можете проверить, что данные были загружены правильно, проверив пользовательский интерфейс MinIO и увидев, доступны ли образцы данных в правильной директории в корзине `wis2box-incoming`.

Вы можете использовать панель управления Grafana, чтобы проверить состояние рабочего процесса загрузки данных.

Наконец, вы можете использовать MQTT Explorer, чтобы проверить, были ли опубликованы уведомления о данных, которые вы загрузили. Вы должны увидеть, что данные CSV были преобразованы в формат BUFR, и что уведомление о данных WIS2 было опубликовано с "каноническим" URL для загрузки данных BUFR.

## Упражнение 2: Загрузка двоичных данных

Далее мы попробуем загрузить двоичные данные в формате BUFR с использованием клиента Python MinIO.

wis2box может загружать двоичные данные в формате BUFR с использованием плагина `wis2box.data.bufr4.ObservationDataBUFR`, включенного в wis2box.

Этот плагин разделит файл BUFR на отдельные сообщения BUFR и опубликует каждое сообщение на брокере MQTT. Если станция для соответствующего сообщения BUFR не определена в метаданных станции wis2box, сообщение не будет опубликовано.

Поскольку вы использовали шаблон `surface-based-observations/synop` на предыдущем занятии, ваши сопоставления данных включают плагин `Данные FM-12, преобразованные в BUFR` для сопоставлений набора данных. Этот плагин загружает модуль `wis2box.data.synop2bufr.ObservationDataSYNOP2BUFR` для загрузки данных.

!!! question "Загрузка двоичных данных в формате BUFR"

    Запустите следующую команду, чтобы скопировать двоичный файл данных `bufr-example.bin` в корзину `wis2box-incoming` в MinIO:

    ```bash
    python3 copy_file_to_incoming.py bufr-example.bin
    ```

Проверьте панель управления Grafana и MQTT Explorer, чтобы увидеть, были ли тестовые данные успешно загружены и опубликованы, и если вы видите какие-либо ошибки, попытайтесь их устранить.

!!! question "Проверьте загрузку данных"

    Сколько сообщений было опубликовано на брокере MQTT для этого образца данных?

??? success "Нажмите, чтобы показать ответ"

    Если вы успешно загрузили и опубликовали последний образец данных, вы должны были получить 10 новых уведомлений на брокере MQTT wis2box. Каждое уведомление соответствует данным одной станции за одну временную отметку наблюдения.

    Плагин `wis2box.data.bufr4.ObservationDataBUFR` разделяет файл BUFR на отдельные сообщения BUFR и публикует одно сообщение для каждой станции и временной отметки наблюдения.

## Упражнение 3: Загрузка данных SYNOP в формате ASCII

На предыдущем занятии мы использовали форму SYNOP в **wis2box-webapp** для загрузки данных SYNOP в формате ASCII. Вы также можете загружать данные SYNOP в формате ASCII, загружая данные в MinIO.

На предыдущем занятии вы должны были создать набор данных, который включал плагин 'Данные FM-12, преобразованные в BUFR' для сопоставлений набора данных:

<img alt="сопоставления набора данных" src="/../assets/img/wis2box-data-mappings.png" width="800">

Этот плагин загружает модуль `wis2box.data.synop2bufr.ObservationDataSYNOP2BUFR` для загрузки данных.

Попробуйте использовать клиент Python MinIO для загрузки тестовых данных `synop-202307.txt` и `synop-202308.txt` в ваш экземпляр wis2box.

Обратите внимание, что в 2 файлах содержится одинаковое содержимое, но имя файла разное. Имя файла используется для определения даты образца данных.

Плагин synop2bufr полагается на шаблон файла для извлечения даты из имени файла. Первая группа в регулярном выражении используется для извлечения года, а вторая группа - для извлечения месяца.

!!! question "Загрузите данные FM-12 SYNOP в формате ASCII"

    Вернитесь в интерфейс MinIO в вашем браузере и перейдите в корзину `wis2box-incoming` и в путь, куда вы загрузили тестовые данные на предыдущем упражнении.
    
    Загрузите новые файлы в правильный путь в корзине `wis2box-incoming` в MinIO, чтобы запустить рабочий процесс загрузки данных.

    Проверьте панель управления Grafana и MQTT Explorer, чтобы увидеть, были ли тестовые данные успешно загружены и опубликованы.

    В чем разница в `properties.datetime` между двумя сообщениями, опубликованными на брокере MQTT?

??? success "Нажмите, чтобы показать ответ"

    Проверьте свойства последних 2 уведомлений в MQTT Explorer, и вы заметите, что одно уведомление имеет:

    ```{.copy}
    "properties": {
        "data_id": "wis2/urn:wmo:md:nl-knmi-test:surface-based-observations.synop/WIGOS_0-20000-0-60355_20230703T090000",
        "datetime": "2023-07-03T09:00:00Z",
        ...
    ```

    а другое уведомление имеет:

    ```{.copy}
    "properties": {
        "data_id": "wis2/urn:wmo:md:nl-knmi-test:surface-based-observations.synop/WIGOS_0-20000-0-60355_20230803T09:00:00Z",
        ...
    ```

    Имя файла использовалось для определения года и месяца образца данных.

## Упражнение 4: Загрузка данных в MinIO с использованием SFTP

Данные также можно загружать в MinIO через SFTP.

Служба MinIO, включенная в стек wis2box, поддерживает SFTP на порту 8022. Вы можете получить доступ к MinIO через SFTP, используя те же учетные данные, что и для пользовательского интерфейса MinIO. В этом упражнении мы будем использовать административные учетные данные для службы MinIO, как определено в `wis2box.env`, но вы также можете создать дополнительных пользователей в пользовательском интерфейсе MinIO.

Для доступа к MinIO через SFTP вы можете использовать любое программное обеспечение-клиент SFTP. В этом упражнении мы будем использовать WinSCP, который является бесплатным клиентом SFTP для Windows.

Используя WinSCP, ваше подключение будет выглядеть следующим образом:

<img alt="подключение winscp-sftp" src="/../assets/img/winscp-sftp-connection.png" width="400">

Для имени пользователя и пароля используйте значения переменных среды `WIS2BOX_STORAGE_USERNAME` и `WIS2BOX_STORAGE_PASSWORD` из вашего файла `wis2box.env`. Нажмите 'save', чтобы сохранить сеанс, а затем 'login', чтобы подключиться.

Когда вы войдете, вы увидите корзины MinIO `wis2box-incoming` и `wis2box-public` в корневом каталоге. Вы можете загружать данные в корзину `wis2box-incoming`, чтобы запустить рабочий процесс загрузки данных.

Щелкните по корзине `wis2box-incoming`, чтобы перейти в эту корзину,