name: Translate and Deploy documentation ⚙️

on:
  push:
    branches:
      - main
    paths:
      - 'documentation/**'
      - 'exercise-materials/**'

defaults:
  run:
    working-directory: documentation

jobs:

  setup-translate:
    runs-on: ubuntu-latest
    env:
      GITHUB_EVENT_BEFORE: ${{ github.event.before }}
      GITHUB_SHA: ${{ github.sha }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    permissions:
      contents: write  # Add this line to grant write access
    outputs:
      translated: ${{ steps.check.outputs.translated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch the entire commit history to get all changes

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install dependencies
        run: |
          pip install openai==1.65.3 anthropic tiktoken python-dotenv

      - name: Run translation script
        id: check
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Running translation script..."
          python translate_changed_files.py --changed-only
          
          # Check if there are new changes to commit
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git diff --cached --quiet && echo "translated=false" >> $GITHUB_OUTPUT || (
            git commit -m "Auto-translated docs"
            git push
            echo "translated=true" >> $GITHUB_OUTPUT
          )

  build-create-exercises-zip:
    needs: setup-translate
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Install requirements 📦
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Deploy 📦
        run: mkdocs gh-deploy --strict --force --message 'update website via GitHub Actions'
      - name: add exercises zipfile 📦
        run: |
          cd ..
          zip -r exercise-materials.zip exercise-materials/
          ls -lh
          git push --set-upstream origin gh-pages
          git config --global user.email "tomkralidis@gmail.com"
          git config --global user.name "Tom Kralidis"
          git checkout gh-pages
          git add exercise-materials.zip
          git commit -m "add exercise-materials zipfile" -a
          git push

  # deploy: # Not used for now
  #   needs: setup-translate
  #   if: needs.setup-translate.outputs.translated == 'true'
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: write
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v3

  #     - name: Set up Python
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: 3.x

  #     - name: Install dependencies
  #       run: |
  #         pip install mkdocs mkdocs-material mkdocs-static-i18n mkdocs-table-reader-plugin mkdocs-print-site-plugin mkdocs-awesome-pages-plugin

  #     - name: Deploy with MkDocs
  #       env:
  #         CI: true
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       run: mkdocs gh-deploy --config-file mkdocs.yml --force